<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DATR - Domain Adaptive Detection Transformer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "sans-serif"] },
          colors: {
            primary: {
              50: "#f8fafc",
              100: "#f1f5f9",
              200: "#e2e8f0",
              300: "#cbd5e1",
              400: "#94a3b8",
              500: "#64748b",
              600: "#475569",
              700: "#334155",
              800: "#1e293b",
              900: "#0f172a",
            },
            accent: { 400: "#fbbf24", 500: "#f59e0b", 600: "#d97706" },
          },
        },
      },
    };
  </script>
  <style>
    .code-block {
      background: #1e1e2e;
      color: #cdd6f4;
    }

    .code-block pre {
      margin: 0;
      white-space: pre-wrap;
      font-size: 0.8rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
  </style>
</head>

<body class="bg-stone-50 text-primary-800 font-sans leading-relaxed">
  <div class="max-w-5xl mx-auto px-4 py-8 md:px-6">
    <!-- Header -->
    <header class="bg-white border border-stone-200 rounded-xl p-8 mb-8 shadow-sm">
      <h1 class="text-3xl md:text-4xl font-bold text-primary-800 mb-2">
        DATR
      </h1>
      <p class="text-lg text-primary-500">
        Domain Adaptive Detection Transformer ‚Äì Ph√°t hi·ªán v·∫≠t th·ªÉ th√¥ng minh
        qua c√°c m√¥i tr∆∞·ªùng kh√°c nhau
      </p>
    </header>

    <!-- Section: V·∫•n ƒë·ªÅ -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        V·∫•n ƒë·ªÅ c·∫ßn gi·∫£i quy·∫øt
      </h2>
      <div class="flex flex-col md:flex-row items-center justify-center gap-6 my-6">
        <div
          class="flex-1 bg-gradient-to-br from-primary-700 to-primary-800 text-white p-5 rounded-lg text-center min-w-[180px]">
          <h3 class="font-semibold mb-1">Domain Ngu·ªìn</h3>
          <p class="text-sm opacity-90">
            D·ªØ li·ªáu hu·∫•n luy·ªán
            <br />
            (V√≠ d·ª•: ·∫¢nh ban ng√†y)
          </p>
        </div>
        <div class="text-3xl text-accent-500 font-bold">‚Üí</div>
        <div
          class="flex-1 bg-gradient-to-br from-rose-500 to-rose-600 text-white p-5 rounded-lg text-center min-w-[180px]">
          <h3 class="font-semibold mb-1">Domain ƒê√≠ch</h3>
          <p class="text-sm opacity-90">
            D·ªØ li·ªáu th·ª±c t·∫ø
            <br />
            (V√≠ d·ª•: ·∫¢nh s∆∞∆°ng m√π)
          </p>
        </div>
      </div>
      <div class="bg-amber-50 border-l-4 border-accent-500 p-4 rounded-r-lg">
        <strong class="text-accent-600">√ù t∆∞·ªüng:</strong>
        M·ªôt m√¥ h√¨nh AI ƒë∆∞·ª£c hu·∫•n luy·ªán tr√™n ·∫£nh ban ng√†y th∆∞·ªùng ho·∫°t ƒë·ªông k√©m
        khi √°p d·ª•ng v√†o ·∫£nh s∆∞∆°ng m√π. DATR gi√∫p kh·∫Øc ph·ª•c v·∫•n ƒë·ªÅ n√†y!
      </div>
    </section>

    <!-- Section: Ki·∫øn tr√∫c -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        Ki·∫øn Tr√∫c DATR
      </h2>
      <div class="space-y-4">
        <!-- B∆∞·ªõc 1: ƒê·∫ßu v√†o -->
        <div class="p-4 bg-stone-50 rounded-lg border-l-4 border-green-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
            <div class="flex-1">
              <strong class="text-green-700">ƒê·∫ßu v√†o (Input Images)</strong>
              <p class="text-sm text-primary-500 mt-1">C·∫∑p ·∫£nh t·ª´ domain ngu·ªìn v√† domain ƒë√≠ch</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Image: [3, 800, 1333] (RGB)</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">Tensor: [3, H, W] normalized</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- B∆∞·ªõc 2: Backbone -->
        <div class="p-4 bg-stone-50 rounded-lg border-l-4 border-blue-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
            <div class="flex-1">
              <strong class="text-blue-700">Backbone (ResNet-50)</strong>
              <p class="text-sm text-primary-500 mt-1">Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng c∆° b·∫£n t·ª´ ·∫£nh</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Image: [3, 800, 1333]</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">Features: [2048, 25, 42]</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- B∆∞·ªõc 3: Transformer Encoder -->
        <div class="p-4 bg-stone-50 rounded-lg border-l-4 border-orange-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
            <div class="flex-1">
              <strong class="text-orange-700">Transformer Encoder</strong>
              <p class="text-sm text-primary-500 mt-1">TƒÉng c∆∞·ªùng ƒë·∫∑c tr∆∞ng b·∫±ng self-attention (6 layers)</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Features: [2048, 25, 42]</p>
                  <p class="text-xs text-primary-400">‚Üí Flatten: [1050, 256]</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">Memory: [1050, 256]</p>
                  <p class="text-xs text-primary-400">Enhanced features</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- B∆∞·ªõc 4: Transformer Decoder -->
        <div class="p-4 bg-stone-50 rounded-lg border-l-4 border-pink-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</span>
            <div class="flex-1">
              <strong class="text-pink-700">Transformer Decoder + Object Queries</strong>
              <p class="text-sm text-primary-500 mt-1">ƒê·ªãnh v·ªã v·∫≠t th·ªÉ qua cross-attention</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Memory: [1050, 256]</p>
                  <p class="text-sm font-mono">Queries: [300, 256]</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">Embeddings: [300, 256]</p>
                  <p class="text-xs text-primary-400">Per-object features</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- B∆∞·ªõc 5: CPA Module -->
        <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold">5</span>
            <div class="flex-1">
              <strong class="text-purple-700">CPA Module (Class-wise Prototype Alignment)</strong>
              <p class="text-sm text-primary-500 mt-1">CƒÉn ch·ªânh prototypes theo t·ª´ng class</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Src_Proto: [C, 256]</p>
                  <p class="text-sm font-mono">Tgt_Proto: [C, 256]</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">L_adv: scalar</p>
                  <p class="text-xs text-primary-400">Adversarial loss</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- B∆∞·ªõc 6: DAS Scheme -->
        <div class="p-4 bg-cyan-50 rounded-lg border-l-4 border-cyan-500">
          <div class="flex items-start gap-4">
            <span
              class="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center text-sm font-bold">6</span>
            <div class="flex-1">
              <strong class="text-cyan-700">DAS Scheme (Dataset-level Alignment)</strong>
              <p class="text-sm text-primary-500 mt-1">Contrastive learning tr√™n to√†n dataset</p>
              <div class="grid md:grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                  <span class="text-xs font-semibold text-blue-600">INPUT:</span>
                  <p class="text-sm font-mono">Memory Bank: [K, 256]</p>
                  <p class="text-sm font-mono">Current Proto: [C, 256]</p>
                </div>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <span class="text-xs font-semibold text-green-600">OUTPUT:</span>
                  <p class="text-sm font-mono">L_contrast: scalar</p>
                  <p class="text-xs text-primary-400">Contrastive loss</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: CPA Module -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        CPA Module - Class-wise Prototypes Alignment
      </h2>
      <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg mb-4">
        <strong>M·ª•c ti√™u:</strong>
        CƒÉn ch·ªânh ƒë·∫∑c tr∆∞ng theo t·ª´ng lo·∫°i v·∫≠t th·ªÉ, kh√¥ng chung chung cho c·∫£
        ·∫£nh
      </div>
      <div class="mb-4">
        <div class="flex gap-2 mb-3">
          <button onclick="switchTab(event, 'tab1')"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-primary-700 text-white">
            B∆∞·ªõc 1: Prototypes
          </button>
          <button onclick="switchTab(event, 'tab2')"
            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-stone-300 text-primary-700">
            B∆∞·ªõc 2: Adversarial
          </button>
        </div>
        <div id="tab1" class="tab-content bg-stone-50 p-4 rounded-lg">
          <p class="mb-3">
            Gom nh√≥m object queries theo class ‚Üí T√≠nh trung b√¨nh ƒë·ªÉ t·∫°o
            prototype
          </p>
          <div class="bg-white p-4 rounded-lg border text-center">
            \[P_c = \frac{1}{N_c} \sum_{i: \text{class}(q_i) = c} q_i\]
          </div>
        </div>
        <div id="tab2" class="tab-content hidden bg-stone-50 p-4 rounded-lg">
          <p class="mb-3">
            Discriminator c·ªë ƒëo√°n domain ‚Üí GRL ƒë·∫£o gradient ƒë·ªÉ bu·ªôc prototypes
            gi·ªëng nhau
          </p>
          <div class="bg-white p-4 rounded-lg border text-center">
            \[\mathcal{L}_{adv} = \text{BCE}(D(\text{GRL}(P)), y_{domain})\]
          </div>
        </div>
      </div>
    </section>

    <!-- Section: DAS Scheme -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        DAS Scheme - Dataset-level Alignment
      </h2>
      <div class="bg-cyan-50 border-l-4 border-cyan-500 p-4 rounded-r-lg mb-4">
        <strong>M·ª•c ti√™u:</strong>
        H·ªçc t·ª´ to√†n b·ªô dataset, kh√¥ng ch·ªâ t·ª´ng batch
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-stone-50 p-4 rounded-lg">
          <h4 class="font-medium mb-2">1. Memory Module</h4>
          <p class="text-sm mb-3">
            L∆∞u tr·ªØ v√† c·∫≠p nh·∫≠t prototypes qua c√°c batch (Moving Average)
          </p>
          <div class="bg-white p-3 rounded-lg border text-center text-sm">
            \[\tilde{P}_c^{(t)} = \frac{n_c \cdot P_c + \tilde{n}_c \cdot
            \tilde{P}_c^{(t-1)}}{n_c + \tilde{n}_c}\]
          </div>
        </div>
        <div class="bg-stone-50 p-4 rounded-lg">
          <h4 class="font-medium mb-2">2. Contrastive Learning</h4>
          <p class="text-sm mb-3">
            K√©o g·∫ßn c√πng class, ƒë·∫©y xa kh√°c class (InfoNCE Loss)
          </p>
          <div class="bg-white p-3 rounded-lg border text-center text-sm">
            \[\mathcal{L}_{con} = -\log \frac{\exp(P_c \cdot \tilde{P}_c /
            \tau)}{\sum_{j=1}^{C} \exp(P_c \cdot \tilde{P}_j / \tau)}\]
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Self-Training -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        Mean-Teacher Self-Training
      </h2>
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div id="stage-1" class="stage flex-1 p-4 rounded-lg text-center bg-primary-700 text-white transition-all">
          <strong>Stage 1: Burn-In</strong>
          <p class="text-sm opacity-90">36 epochs ‚Äì Ch·ªâ train Student</p>
        </div>
        <div id="stage-2" class="stage flex-1 p-4 rounded-lg text-center bg-stone-200 text-primary-700 transition-all">
          <strong>Stage 2: Mutual Learning</strong>
          <p class="text-sm">10 epochs ‚Äì Teacher + Student</p>
        </div>
      </div>
      <div class="space-y-3">
        <div class="flex items-start gap-3 p-3 bg-stone-50 rounded-lg border-l-4 border-green-500">
          <strong class="min-w-[120px]">Student Model</strong>
          <span class="text-sm text-primary-500">
            H·ªçc t·ª´ d·ªØ li·ªáu c√≥ nh√£n (source) + pseudo-labels (target)
          </span>
        </div>
        <div class="flex items-start gap-3 p-3 bg-stone-50 rounded-lg border-l-4 border-blue-500">
          <strong class="min-w-[120px]">Teacher Model</strong>
          <span class="text-sm text-primary-500">
            C·∫≠p nh·∫≠t t·ª´ Student qua EMA: \(\theta_{teacher} \leftarrow \alpha
            \cdot \theta_{teacher} + (1-\alpha) \cdot \theta_{student}\)
          </span>
        </div>
        <div class="flex items-start gap-3 p-3 bg-stone-50 rounded-lg border-l-4 border-orange-500">
          <strong class="min-w-[120px]">Pseudo-labels</strong>
          <span class="text-sm text-primary-500">
            Teacher t·∫°o nh√£n cho ·∫£nh target (kh√¥ng c√≥ nh√£n th·∫≠t)
          </span>
        </div>
      </div>
    </section>

    <!-- Section: Loss Functions -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        H√†m Loss T·ªïng H·ª£p
      </h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-stone-50 p-4 rounded-lg">
          <h3 class="font-medium mb-3">Stage 1 - Burn-In:</h3>
          <div class="bg-white p-4 rounded-lg border text-center">
            \[\mathcal{L} = \mathcal{L}_{det}(P_{src}, Y_{src}) + \lambda_a
            \mathcal{L}_{adv} + \lambda_c \mathcal{L}_{con}\]
          </div>
        </div>
        <div class="bg-stone-50 p-4 rounded-lg">
          <h3 class="font-medium mb-3">Stage 2 - Mutual Learning:</h3>
          <div class="bg-white p-4 rounded-lg border text-center">
            \[\mathcal{L} = \mathcal{L}_{det} + \lambda_{unsup}
            \mathcal{L}_{det}^{tgt} + \lambda_a \mathcal{L}_{adv} + \lambda_c
            \mathcal{L}_{con}\]
          </div>
        </div>
      </div>
      <div class="mt-4 bg-amber-50 border border-amber-200 p-4 rounded-lg">
        <p class="text-sm mb-2"><strong>Gi·∫£i th√≠ch:</strong></p>
        <ul class="text-sm space-y-1">
          <li>
            \(\mathcal{L}_{det}\) = Loss ph√°t hi·ªán (classification + bbox +
            GIoU)
          </li>
          <li>\(\mathcal{L}_{adv}\) = Loss adversarial t·ª´ CPA module</li>
          <li>\(\mathcal{L}_{con}\) = Loss contrastive t·ª´ DAS scheme</li>
          <li>\(\lambda_a = \lambda_c = 0.1\), \(\lambda_{unsup} = 1.0\)</li>
        </ul>
      </div>
    </section>

    <!-- Section: K·∫øt qu·∫£ -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        K·∫øt Qu·∫£ Th·ª±c Nghi·ªám
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-primary-800 text-white p-5 rounded-lg text-center">
          <h3 class="text-sm font-medium opacity-80 mb-1">
            Weather Adaptation
          </h3>
          <p class="text-xs opacity-70">Cityscapes ‚Üí Foggy</p>
          <p class="text-3xl font-bold my-2">52.8%</p>
          <p class="text-xs opacity-70">mAP (+1.6% vs SOTA)</p>
        </div>
        <div class="bg-primary-700 text-white p-5 rounded-lg text-center">
          <h3 class="text-sm font-medium opacity-80 mb-1">
            Synthetic-to-Real
          </h3>
          <p class="text-xs opacity-70">Sim10k ‚Üí Cityscapes</p>
          <p class="text-3xl font-bold my-2">66.3%</p>
          <p class="text-xs opacity-70">mAP (+4.3% vs SOTA)</p>
        </div>
        <div class="bg-primary-600 text-white p-5 rounded-lg text-center">
          <h3 class="text-sm font-medium opacity-80 mb-1">
            Scene Adaptation
          </h3>
          <p class="text-xs opacity-70">Cityscapes ‚Üí BDD100k</p>
          <p class="text-3xl font-bold my-2">41.9%</p>
          <p class="text-xs opacity-70">mAP (+8.2% vs SOTA)</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead>
            <tr class="bg-primary-700 text-white">
              <th class="p-3 text-left">Ph∆∞∆°ng ph√°p</th>
              <th class="p-3 text-left">Cityscapes ‚Üí Foggy</th>
              <th class="p-3 text-left">Sim10k ‚Üí Cityscapes</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b border-stone-200 hover:bg-stone-50">
              <td class="p-3">Source-only DINO</td>
              <td class="p-3">35.6%</td>
              <td class="p-3">52.6%</td>
            </tr>
            <tr class="border-b border-stone-200 hover:bg-stone-50">
              <td class="p-3">+ Backbone Align</td>
              <td class="p-3">42.5%</td>
              <td class="p-3">‚Äî</td>
            </tr>
            <tr class="border-b border-stone-200 hover:bg-stone-50">
              <td class="p-3">+ CPA</td>
              <td class="p-3">46.9%</td>
              <td class="p-3">‚Äî</td>
            </tr>
            <tr class="border-b border-stone-200 hover:bg-stone-50">
              <td class="p-3">+ DAS</td>
              <td class="p-3">48.7%</td>
              <td class="p-3">‚Äî</td>
            </tr>
            <tr class="bg-green-50 font-semibold">
              <td class="p-3">DATR (Full)</td>
              <td class="p-3 text-green-700">52.8%</td>
              <td class="p-3 text-green-700">66.3%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Section: ƒêi·ªÉm m·∫°nh -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        ƒêi·ªÉm M·∫°nh C·ªßa DATR
      </h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div
          class="border border-stone-200 p-4 rounded-lg text-center hover:border-accent-500 hover:shadow-md transition-all">
          <div class="text-2xl mb-2">üéØ</div>
          <h3 class="font-medium text-sm">Class-aware</h3>
          <p class="text-xs text-primary-500 mt-1">
            CƒÉn ch·ªânh theo t·ª´ng lo·∫°i v·∫≠t th·ªÉ
          </p>
        </div>
        <div
          class="border border-stone-200 p-4 rounded-lg text-center hover:border-accent-500 hover:shadow-md transition-all">
          <div class="text-2xl mb-2">üåç</div>
          <h3 class="font-medium text-sm">Dataset-level</h3>
          <p class="text-xs text-primary-500 mt-1">H·ªçc t·ª´ to√†n b·ªô dataset</p>
        </div>
        <div
          class="border border-stone-200 p-4 rounded-lg text-center hover:border-accent-500 hover:shadow-md transition-all">
          <div class="text-2xl mb-2">‚ö°</div>
          <h3 class="font-medium text-sm">Efficient</h3>
          <p class="text-xs text-primary-500 mt-1">T√≠nh to√°n batch nhanh</p>
        </div>
        <div
          class="border border-stone-200 p-4 rounded-lg text-center hover:border-accent-500 hover:shadow-md transition-all">
          <div class="text-2xl mb-2">üë®‚Äçüè´</div>
          <h3 class="font-medium text-sm">Self-Training</h3>
          <p class="text-xs text-primary-500 mt-1">
            Mean-Teacher pseudo-labels
          </p>
        </div>
      </div>
    </section>

    <!-- Section: M√¥ ph·ªèng -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        M√¥ Ph·ªèng DATR Step-by-Step
      </h2>
      <div class="bg-amber-50 border-l-4 border-accent-500 p-4 rounded-r-lg mb-4">
        <strong>M·ª•c ti√™u:</strong>
        B·∫°n s·∫Ω tr·ª±c ti·∫øp ƒëi·ªÅu khi·ªÉn t·ª´ng b∆∞·ªõc x·ª≠ l√Ω c·ªßa DATR!
      </div>

      <!-- Visualization Stages -->
      <div class="space-y-4">
        <!-- Stage 1: Input -->
        <div id="stage-input" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-green-500">
          <h4 class="font-semibold text-green-700 mb-3">
            Stage 1: Input Images
          </h4>
          <div class="flex flex-wrap gap-4 justify-center mb-4">
            <div class="bg-primary-700 text-white p-4 rounded-lg text-center min-w-[180px]">
              <p class="font-medium">Source Domain</p>
              <p class="text-xs opacity-80">Cityscapes (Clear)</p>
              <p class="text-xs bg-black/20 rounded px-2 py-1 mt-2 font-mono">
                [1, 3, 800, 1333]
              </p>
            </div>
            <div class="bg-rose-500 text-white p-4 rounded-lg text-center min-w-[180px]">
              <p class="font-medium">Target Domain</p>
              <p class="text-xs opacity-80">Foggy Cityscapes</p>
              <p class="text-xs bg-black/20 rounded px-2 py-1 mt-2 font-mono">
                [1, 3, 800, 1333]
              </p>
            </div>
          </div>
          <div class="code-block p-3 rounded-lg text-xs">
            <pre>
# Code t∆∞∆°ng ·ª©ng:
images_src = load_batch(source_domain)  # Shape: [B, 3, H, W]
images_tgt = load_batch(target_domain)  # Shape: [B, 3, H, W]</pre>
          </div>
        </div>

        <!-- Stage 2: Features -->
        <div id="stage-features" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-blue-500">
          <h4 class="font-semibold text-blue-700 mb-3">
            Stage 2: Backbone Feature Extraction (ResNet-50)
          </h4>
          <div class="flex flex-wrap items-center justify-center gap-3 mb-4">
            <div class="bg-white border-2 border-primary-300 p-3 rounded-lg text-center">
              <strong>Input</strong>
              <p class="text-xs font-mono">[B, 3, 800, 1333]</p>
            </div>
            <span class="text-2xl text-primary-400">‚Üí</span>
            <div class="bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center">
              <strong>Conv Layers</strong>
            </div>
            <span class="text-2xl text-primary-400">‚Üí</span>
            <div class="bg-white border-2 border-primary-300 p-3 rounded-lg text-center">
              <strong>Features</strong>
              <p class="text-xs font-mono">[B, 2048, 25, 42]</p>
            </div>
          </div>
          <div class="code-block p-3 rounded-lg text-xs">
            <pre>
# Code t∆∞∆°ng ·ª©ng:
backbone = ResNet50(pretrained=True)
features_src = backbone(images_src)  # Shape: [B, 2048, H/32, W/32]
features_tgt = backbone(images_tgt)
print(f"Extracted features shape: {features_src.shape}")</pre>
          </div>
        </div>

        <!-- Stage 3: Encoder -->
        <div id="stage-encoder" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-orange-500">
          <h4 class="font-semibold text-orange-700 mb-3">
            Stage 3: Transformer Encoder
          </h4>
          <div id="attention-grid" class="grid grid-cols-8 gap-1 max-w-xs mx-auto mb-4"></div>
          <div class="code-block p-3 rounded-lg text-xs mb-3">
            <pre>
# Code t∆∞∆°ng ·ª©ng:
encoder = TransformerEncoder(d_model=256, nhead=8, num_layers=6)
src_flatten = features_src.flatten(2).permute(2, 0, 1)  # [HW, B, C]
pos_embed = PositionalEncoding2D(features_src)
memory_src = encoder(src_flatten + pos_embed)  # Shape: [HW, B, 256]
print(f"Encoder output shape: {memory_src.shape}")</pre>
          </div>
          <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r text-sm">
            <strong>Encoder l√†m g√¨?</strong>
            TƒÉng c∆∞·ªùng features b·∫±ng self-attention, m·ªói v·ªã tr√≠ "nh√¨n th·∫•y"
            to√†n b·ªô ·∫£nh
          </div>
        </div>

        <!-- Stage 4: Decoder -->
        <div id="stage-decoder" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-pink-500">
          <h4 class="font-semibold text-pink-700 mb-3">
            Stage 4: Transformer Decoder - Object Queries
          </h4>
          <div class="text-center my-4">
            <div class="inline-block p-4 bg-amber-50 border border-amber-200 rounded-lg">
              <strong>Object Queries</strong>
              <div id="queries-display" class="mt-2 flex flex-wrap gap-1 justify-center"></div>
            </div>
          </div>
          <div class="code-block p-3 rounded-lg text-xs mb-3">
            <pre>
# Code t∆∞∆°ng ·ª©ng:
decoder = TransformerDecoder(d_model=256, nhead=8, num_layers=6)
query_embed = nn.Embedding(300, 256)
queries = query_embed.weight.unsqueeze(1).repeat(1, B, 1)  # [300, B, 256]
hs_src = decoder(queries, memory_src)  # [6, 300, B, 256]
output_src = hs_src[-1]  # [300, B, 256]

# Prediction heads
class_head = nn.Linear(256, num_classes)
bbox_head = MLP(256, 256, 4, 3)
logits_src = class_head(output_src)  # [300, B, num_classes]
boxes_src = bbox_head(output_src).sigmoid()  # [300, B, 4]</pre>
          </div>
          <div id="predictions-display" class="mt-3"></div>
        </div>

        <!-- Stage 5: CPA -->
        <div id="stage-cpa" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-purple-500">
          <h4 class="font-semibold text-purple-700 mb-3">
            Stage 5: CPA Module - Class-wise Prototypes Alignment
          </h4>

          <div class="bg-purple-50 p-4 rounded-lg mb-4">
            <strong>Step 5.1: Extract Class-wise Prototypes</strong>
            <div id="prototypes-visual" class="mt-3"></div>
          </div>

          <div class="code-block p-3 rounded-lg text-xs mb-4">
            <pre>
# Code t∆∞∆°ng ·ª©ng:
def extract_class_prototypes(output, logits):
    pred_classes = logits.argmax(dim=-1)  # [N, B]
    prototypes = []
    for c in range(num_classes):
        mask_c = (pred_classes == c).float()
        prototype_c = (output * mask_c).sum(0) / (mask_c.sum() + 1e-6)
        prototypes.append(prototype_c)
    return torch.stack(prototypes)  # [C, 256]

proto_src = extract_class_prototypes(output_src, logits_src)
proto_tgt = extract_class_prototypes(output_tgt, logits_tgt)</pre>
          </div>

          <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <strong>Step 5.2: Adversarial Learning</strong>
            <div class="flex justify-around items-center flex-wrap gap-4 mt-3">
              <div class="text-center">
                <div class="w-12 h-12 bg-blue-500 rounded-full mx-auto"></div>
                <p class="text-sm mt-1">Source Proto</p>
              </div>
              <span class="text-2xl">‚Üí</span>
              <div class="text-center bg-amber-100 p-3 rounded-lg">
                <strong>Discriminator</strong>
                <p class="text-xs">Source or Target?</p>
              </div>
              <span class="text-2xl">‚Üê</span>
              <div class="text-center">
                <div class="w-12 h-12 bg-red-500 rounded-full mx-auto"></div>
                <p class="text-sm mt-1">Target Proto</p>
              </div>
            </div>
          </div>

          <div class="code-block p-3 rounded-lg text-xs mb-3">
            <pre>
# Adversarial Training with GRL:
discriminator = DomainDiscriminator(in_dim=256)
all_prototypes = torch.cat([proto_src, proto_tgt], dim=0)
reversed_features = GradientReversalFunction.apply(all_prototypes, 0.1)
domain_pred = discriminator(reversed_features)
L_adv = F.binary_cross_entropy(domain_pred, domain_labels)</pre>
          </div>

          <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r text-sm">
            <strong>CPA ho·∫°t ƒë·ªông:</strong>
            GRL ƒë·∫£o ng∆∞·ª£c gradient ‚Üí bu·ªôc prototypes c·ªßa 2 domain gi·ªëng nhau
          </div>
        </div>

        <!-- Stage 6: DAS -->
        <div id="stage-das" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-cyan-500">
          <h4 class="font-semibold text-cyan-700 mb-3">
            Stage 6: DAS Scheme - Dataset-level Alignment
          </h4>

          <div class="bg-cyan-50 p-4 rounded-lg mb-4">
            <strong>Step 6.1: Memory Module</strong>
            <div id="memory-visual" class="mt-3"></div>
          </div>

          <div class="code-block p-3 rounded-lg text-xs mb-4">
            <pre>
# Memory Module - Dataset-level Prototypes:
class MemoryModule:
    def __init__(self, num_classes, feature_dim=256):
        self.dataset_prototypes = torch.zeros(num_classes, feature_dim)
        self.counts = torch.zeros(num_classes)
    
    def update(self, class_prototypes, class_counts):
        for c in range(num_classes):
            if class_counts[c] > 0:
                # Moving average update
                self.dataset_prototypes[c] = (
                    class_prototypes[c] * class_counts[c] + 
                    self.dataset_prototypes[c] * self.counts[c]
                ) / (class_counts[c] + self.counts[c] + 1e-6)
                self.counts[c] += class_counts[c]
        return self.dataset_prototypes</pre>
          </div>

          <div class="bg-orange-50 p-4 rounded-lg mb-4">
            <strong>Step 6.2: Contrastive Learning</strong>
            <p class="text-sm my-2">
              <span class="text-green-600">‚úì K√©o g·∫ßn c√πng class</span>
              |
              <span class="text-red-600">‚úó ƒê·∫©y xa kh√°c class</span>
            </p>
            <div id="contrastive-matrix" class="overflow-x-auto"></div>
          </div>

          <div class="code-block p-3 rounded-lg text-xs mb-3">
            <pre>
# Contrastive Loss:
def contrastive_loss(proto_src, proto_tgt, dataset_proto, temperature=0.07):
    proto_norm = F.normalize(proto_src, dim=1)
    dataset_norm = F.normalize(dataset_proto, dim=1)
    loss = 0.0
    for i in range(C):
        pos = torch.exp(torch.dot(proto_norm[i], dataset_norm[i]) / temperature)
        neg = torch.sum(torch.exp(torch.matmul(proto_norm, dataset_norm[i]) / temperature))
        loss += -torch.log(pos / neg)
    return loss / C</pre>
          </div>

          <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r text-sm">
            <strong>DAS ho·∫°t ƒë·ªông:</strong>
            Memory module t√≠ch l≈©y prototypes ‚Üí Contrastive learning cƒÉn ch·ªânh
            to√†n dataset
          </div>
        </div>

        <!-- Stage 7: Loss -->
        <div id="stage-loss" class="hidden fade-in bg-stone-50 p-5 rounded-lg border-l-4 border-red-500">
          <h4 class="font-semibold text-red-700 mb-3">
            Stage 7: Total Loss Computation
          </h4>

          <!-- Loss Formula Display -->
          <div class="bg-white p-5 rounded-lg border mb-4">
            <div class="text-center mb-4">
              <strong class="text-primary-700 text-lg">Total Loss Function:</strong>
              <div class="mt-3 text-xl">
                \( \mathcal{L}_{total} = \mathcal{L}_{det} + \lambda_a \mathcal{L}_{adv} + \lambda_c \mathcal{L}_{con}
                \)
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                <strong class="text-blue-700">Detection Loss</strong>
                <div class="mt-2 text-sm">
                  \( \mathcal{L}_{det} = \text{CE} + \mathcal{L}_{box} \)
                </div>
                <div id="loss-det-value" class="font-mono font-bold text-blue-600 mt-2">‚Äî</div>
              </div>
              <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 text-center">
                <strong class="text-purple-700">Adversarial Loss</strong>
                <div class="mt-2 text-sm">
                  \( \mathcal{L}_{adv} = \text{BCE}(D(P), y) \)
                </div>
                <div id="loss-adv-value" class="font-mono font-bold text-purple-600 mt-2">‚Äî</div>
              </div>
              <div class="bg-cyan-50 p-4 rounded-lg border border-cyan-200 text-center">
                <strong class="text-cyan-700">Contrastive Loss</strong>
                <div class="mt-2 text-sm">
                  \( \mathcal{L}_{con} = -\log\frac{e^{sim/\tau}}{\sum e^{sim/\tau}} \)
                </div>
                <div id="loss-con-value" class="font-mono font-bold text-cyan-600 mt-2">‚Äî</div>
              </div>
            </div>

            <div class="bg-stone-50 p-4 rounded-lg border mt-4">
              <div class="text-center">
                <strong>Calculation:</strong>
                <div class="mt-2 font-mono text-sm">
                  \( \mathcal{L}_{total} = \) <span id="loss-det-calc">?</span> \( + 0.1 \times \) <span
                    id="loss-adv-calc">?</span> \( + 0.1 \times \) <span id="loss-con-calc">?</span>
                </div>
                <div class="text-red-600 font-bold text-2xl mt-3" id="total-loss-value">= ?</div>
              </div>
            </div>
          </div>

          <div id="loss-breakdown" class="mb-4"></div>

          <div class="code-block p-3 rounded-lg text-xs mb-3">
            <pre>
# Total Loss:
L_total = L_det + Œª_a * L_adv + Œª_c * L_contrast
        = L_det + 0.1 * L_adv + 0.1 * L_contrast

# Backward and optimize
optimizer.zero_grad()
L_total.backward()
optimizer.step()

# Update teacher with EMA
Œ∏_teacher = Œ± * Œ∏_teacher + (1-Œ±) * Œ∏_student
# where Œ± = 0.999</pre>
          </div>

          <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r text-sm">
            <strong>Loss Components:</strong>
            <div class="mt-2">
              \( \mathcal{L}_{det} \) (detection) + \( \lambda_a \times \mathcal{L}_{adv} \) (CPA) + \( \lambda_c \times
              \mathcal{L}_{con} \) (DAS)
            </div>
          </div>
        </div>
      </div>

      <!-- Control Panel - At bottom of stages -->
      <div class="bg-primary-900 text-white p-5 rounded-lg mt-4">
        <h3 class="text-green-400 font-medium mb-3">B·∫£ng ƒêi·ªÅu Khi·ªÉn</h3>
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-sm transition-colors"
            onclick="loadImages()">
            1. Load Images
          </button>
          <button
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-extract" disabled onclick="extractFeatures()">
            2. Extract Features
          </button>
          <button
            class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-encoder" disabled onclick="runEncoder()">
            3. Run Encoder
          </button>
          <button
            class="px-4 py-2 bg-pink-600 hover:bg-pink-700 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-decoder" disabled onclick="runDecoder()">
            4. Run Decoder
          </button>
          <button
            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-cpa" disabled onclick="runCPA()">
            5. Run CPA
          </button>
          <button
            class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-das" disabled onclick="runDAS()">
            6. Run DAS
          </button>
          <button class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm transition-colors disabled:opacity-50"
            id="btn-loss" disabled onclick="computeLoss()">
            7. Compute Loss
          </button>
          <button class="px-4 py-2 bg-stone-600 hover:bg-stone-700 rounded-md text-sm transition-colors"
            onclick="resetSimulation()">
            Reset
          </button>
        </div>
        <div id="status-display" class="bg-primary-800 p-4 rounded-lg font-mono text-sm max-h-32 overflow-y-auto">
          <div class="text-green-400">
            >>> System Ready. Click "Load Images" to start...
          </div>
        </div>
      </div>

      <!-- Training Stats -->
      <div class="bg-primary-800 text-white p-5 rounded-lg mt-4">
        <h3 class="font-medium mb-3">Training Statistics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="bg-white/10 p-3 rounded text-center">
            <div class="text-2xl font-bold" id="stat-epoch">0</div>
            <div class="text-xs opacity-70">Epoch</div>
          </div>
          <div class="bg-white/10 p-3 rounded text-center">
            <div class="text-2xl font-bold" id="stat-loss">0.000</div>
            <div class="text-xs opacity-70">Total Loss</div>
          </div>
          <div class="bg-white/10 p-3 rounded text-center">
            <div class="text-2xl font-bold" id="stat-map">0.0%</div>
            <div class="text-xs opacity-70">mAP</div>
          </div>
          <div class="bg-white/10 p-3 rounded text-center">
            <div class="text-2xl font-bold" id="stat-samples">0</div>
            <div class="text-xs opacity-70">Samples</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Colab Guide -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        Quy tr√¨nh training tr√™n Colab
      </h2>
      <div class="space-y-2 text-sm">
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">1.</span>
          <span>Chu·∫©n b·ªã d·ªØ li·ªáu: Upload dataset l√™n Google Drive</span>
        </div>
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">2.</span>
          <span>
            Clone repo:
            <code class="bg-stone-200 px-1 rounded">
                git clone https://github.com/h751410234/DATR
              </code>
          </span>
        </div>
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">3.</span>
          <span>C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n trong notebook</span>
        </div>
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">4.</span>
          <span>
            Stage 1:
            <code class="bg-stone-200 px-1 rounded">
                sh scripts/DINO_train.sh
              </code>
            (36 epochs)
          </span>
        </div>
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">5.</span>
          <span>
            Stage 2:
            <code class="bg-stone-200 px-1 rounded">
                sh scripts/DINO_train_self_training.sh
              </code>
            (10 epochs)
          </span>
        </div>
        <div class="flex gap-3 p-3 bg-stone-50 rounded">
          <span class="font-bold text-accent-600">6.</span>
          <span>
            ƒê√°nh gi√°:
            <code class="bg-stone-200 px-1 rounded">
                sh scripts/DINO_eval.sh
              </code>
          </span>
        </div>
      </div>
      <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg mt-4">
        <strong>Hyperparameters:</strong>
        <div class="mt-2 text-sm">
          \(\text{LR} = 2 \times 10^{-4}\) ‚Ä¢ \(\lambda_a = \lambda_c = 0.1\) ‚Ä¢
          \(\lambda_{unsup} = 1.0\) ‚Ä¢ \(\alpha_{EMA} = 0.999\) ‚Ä¢
          \(\text{Threshold} = 0.3\)
        </div>
      </div>
    </section>

    <!-- Section: M√¥ Ph·ªèng Chi Ti·∫øt Step-by-Step (Easy to Understand) -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        H√£y C√πng Nhau T√¨m Hi·ªÉu DATR Ho·∫°t ƒê·ªông Nh∆∞ Th·∫ø N√†o
      </h2>

      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6">
        <p class="text-sm">
          <strong>√ù t∆∞·ªüng ch√≠nh:</strong>
          DATR c√≥ 2 "ng∆∞·ªùi anh em" l√† Student v√† Teacher. Student h·ªçc t·ª´
          source (·∫£nh ban ng√†y) v√† target (·∫£nh s∆∞∆°ng m√π). Teacher h·ªó tr·ª£ b·∫±ng
          c√°ch cho ƒëi·ªÉm s·ªë nh·ªØng g√¨ Student d·ª± ƒëo√°n. C·ª© v·∫≠y l·∫∑p l·∫°i, c·∫£ 2 ƒë·ªÅu
          th√¥ng minh h∆°n!
        </p>
      </div>

      <!-- Progress Bar for Easy Simulation -->
      <div id="easy-progress-container" class="hidden mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-primary-700">Ti·∫øn ƒë·ªô:</span>
          <span id="easy-progress-text" class="text-sm text-primary-500">0/7 b∆∞·ªõc</span>
        </div>
        <div class="w-full bg-stone-200 rounded-full h-3">
          <div id="easy-progress-bar"
            class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500"
            style="width: 0%"></div>
        </div>
      </div>

      <!-- Start Button for Easy Simulation -->
      <div id="easy-start-container" class="text-center mb-6">
        <button onclick="initEasySimulation()" id="easy-start-btn"
          class="bg-accent-500 hover:bg-accent-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
          B·∫Øt ƒë·∫ßu
        </button>
      </div>

      <!-- Simple Simulation Output -->
      <div id="easy-simulation-output" class="space-y-4"></div>

      <!-- Control Buttons at Bottom for Easy Simulation -->
      <div id="easy-nav-container" class="hidden mt-6 pt-4 border-t border-stone-200">
        <div class="flex items-center justify-between">
          <button onclick="resetEasySimulation()" id="easy-reset-btn"
            class="bg-stone-500 hover:bg-stone-600 text-white font-medium py-2 px-5 rounded-lg text-sm transition-all">
            L√†m l·∫°i
          </button>
          <button onclick="nextEasyStep()" id="easy-next-btn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
            B∆∞·ªõc ti·∫øp theo
          </button>
        </div>
      </div>
    </section>

    <!-- Section: M√¥ Ph·ªèng Chi Ti·∫øt V·ªõi S·ªë Li·ªáu Th·ª±c -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        Theo D√µi D·ªØ Li·ªáu T·ª´ng B∆∞·ªõc - T·ª´ ·∫¢nh G·ªëc ƒê·∫øn K·∫øt Qu·∫£
      </h2>

      <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg mb-6">
        <p class="text-sm">
          <strong>√ù t∆∞·ªüng:</strong>
          Ch√∫ng ta s·∫Ω "theo d√µi" m·ªôt b·ª©c ·∫£nh th·ª±c t·∫ø t·ª´ l√∫c n√≥ v·ª´a ƒë∆∞·ª£c load
          v√†o m√°y t√≠nh cho ƒë·∫øn l√∫c m√¥ h√¨nh n√≥ c√≥ c√¢u tr·∫£ l·ªùi "C√¢y con c√≥ ·ªü v·ªã
          tr√≠ (x, y)"
        </p>
      </div>

      <!-- Progress Bar for Detailed Simulation -->
      <div id="detailed-progress-container" class="hidden mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-primary-700">Ti·∫øn ƒë·ªô x·ª≠ l√Ω:</span>
          <span id="detailed-progress-text" class="text-sm text-primary-500">0/7 b∆∞·ªõc</span>
        </div>
        <div class="w-full bg-stone-200 rounded-full h-3">
          <div id="detailed-progress-bar"
            class="bg-gradient-to-r from-indigo-500 to-pink-500 h-3 rounded-full transition-all duration-500"
            style="width: 0%"></div>
        </div>
      </div>

      <!-- Start Button for Detailed Simulation -->
      <div id="detailed-start-container" class="text-center mb-6">
        <button onclick="initDetailedSimulation()" id="detailed-start-btn"
          class="bg-accent-500 hover:bg-accent-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
          B·∫Øt ƒë·∫ßu
        </button>
      </div>

      <!-- Detailed Step-by-Step Output -->
      <div id="detailed-step-output" class="space-y-4"></div>

      <!-- Control Buttons at Bottom for Detailed Simulation -->
      <div id="detailed-nav-container" class="hidden mt-6 pt-4 border-t border-stone-200">
        <div class="flex items-center justify-between">
          <button onclick="resetDetailedSimulation()" id="detailed-reset-btn"
            class="bg-stone-500 hover:bg-stone-600 text-white font-medium py-2 px-5 rounded-lg text-sm transition-all">
            L√†m l·∫°i
          </button>
          <button onclick="nextDetailedStep()" id="detailed-next-btn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
            B∆∞·ªõc ti·∫øp theo
          </button>
        </div>
      </div>
    </section>

    <!-- Section: Minh H·ªça Tr·ª±c Quan DATR Pipeline (Step-by-Step) -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        Minh H·ªça Tr·ª±c Quan: DATR Pipeline
      </h2>

      <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg mb-6">
        <p class="text-sm">
          <strong>T∆∞∆°ng t√°c:</strong>
          Click "B·∫Øt ƒë·∫ßu" r·ªìi "B∆∞·ªõc ti·∫øp theo" ƒë·ªÉ xem t·ª´ng b∆∞·ªõc x·ª≠ l√Ω c·ªßa DATR v·ªõi h√¨nh ·∫£nh minh h·ªça
        </p>
      </div>

      <!-- Progress Bar -->
      <div id="visual-progress-container" class="hidden mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-primary-700">Ti·∫øn ƒë·ªô:</span>
          <span id="visual-progress-text" class="text-sm text-primary-500">0/7 b∆∞·ªõc</span>
        </div>
        <div class="w-full bg-stone-200 rounded-full h-3">
          <div id="visual-progress-bar"
            class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500"
            style="width: 0%"></div>
        </div>
      </div>

      <!-- Start Button -->
      <div id="visual-start-container" class="text-center mb-6">
        <button onclick="initVisualSimulation()" id="visual-start-btn"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
          B·∫Øt ƒë·∫ßu xem minh h·ªça
        </button>
      </div>

      <!-- Visual Step Output -->
      <div id="visual-step-output" class="space-y-4"></div>

      <!-- Control Buttons -->
      <div id="visual-nav-container" class="hidden mt-6 pt-4 border-t border-stone-200">
        <div class="flex items-center justify-between">
          <button onclick="resetVisualSimulation()" id="visual-reset-btn"
            class="bg-stone-500 hover:bg-stone-600 text-white font-medium py-2 px-5 rounded-lg text-sm transition-all">
            L√†m l·∫°i
          </button>
          <button onclick="nextVisualStep()" id="visual-next-btn"
            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105">
            B∆∞·ªõc ti·∫øp theo
          </button>
        </div>
      </div>
    </section>

    <!-- Section: T·ªïng k·∫øt -->
    <section class="bg-white border border-stone-200 rounded-xl p-6 md:p-8 mb-6 shadow-sm">
      <h2 class="text-xl font-semibold text-primary-700 mb-4 pb-2 border-b-2 border-accent-500">
        T·ªïng K·∫øt
      </h2>
      <div class="bg-teal-50 border-l-4 border-teal-500 p-4 rounded-r-lg mb-4">
        <h3 class="font-semibold mb-2">DATR l√† g√¨?</h3>
        <p class="text-sm">
          DATR l√† m·ªôt detector th√¥ng minh c√≥ kh·∫£ nƒÉng
          <strong>t·ª± th√≠ch nghi</strong>
          khi chuy·ªÉn t·ª´ m√¥i tr∆∞·ªùng hu·∫•n luy·ªán sang m√¥i tr∆∞·ªùng th·ª±c t·∫ø kh√°c
          bi·ªát. Gi·ªëng nh∆∞ m·ªôt ng∆∞·ªùi bi·∫øt l√°i xe ban ng√†y, DATR gi√∫p h·ªç nhanh
          ch√≥ng th√≠ch nghi v·ªõi ƒëi·ªÅu ki·ªán l√°i xe ban ƒë√™m ho·∫∑c trong s∆∞∆°ng m√π.
        </p>
      </div>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <strong class="text-blue-700">1. CPA Module</strong>
          <p class="text-sm mt-1">
            CƒÉn ch·ªânh ƒë·∫∑c tr∆∞ng theo t·ª´ng lo·∫°i v·∫≠t th·ªÉ
          </p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <strong class="text-purple-700">2. DAS Scheme</strong>
          <p class="text-sm mt-1">
            H·ªçc t·ª´ to√†n b·ªô dataset v·ªõi contrastive learning
          </p>
        </div>
        <div class="bg-orange-50 p-4 rounded-lg">
          <strong class="text-orange-700">3. Self-Training</strong>
          <p class="text-sm mt-1">T·∫≠n d·ª•ng pseudo-labels t·ª´ Mean-Teacher</p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary-800 text-white p-6 rounded-xl text-center">
      <h3 class="font-semibold mb-2">T√†i Nguy√™n</h3>
      <p class="text-sm opacity-80 mb-1">
        <strong>Paper:</strong>
        DATR: Unsupervised Domain Adaptive Detection Transformer (arXiv 2024)
      </p>
      <p class="text-sm opacity-80">
        <strong>Code:</strong>
        github.com/h751410234/DATR
      </p>
    </footer>
  </div>

  <script>
    let currentStep = 0;
    let simulationData = {
      epoch: 0,
      totalLoss: 0,
      mAP: 0,
      samplesProcessed: 0,
    };

    function addLog(msg, type = "info") {
      const display = document.getElementById("status-display");
      const colors = {
        success: "text-green-400",
        info: "text-blue-300",
        warning: "text-yellow-400",
        error: "text-red-400",
      };
      const time = new Date().toLocaleTimeString();
      display.innerHTML += `<div class="${colors[type]}">[${time}] ${msg}</div>`;
      display.scrollTop = display.scrollHeight;
    }

    function enableButton(id) {
      document.getElementById(id).disabled = false;
    }

    function loadImages() {
      addLog(">>> Loading image batch...", "info");
      setTimeout(() => {
        addLog("‚úì Loaded 2 images (source + target)", "success");
        document.getElementById("stage-input").classList.remove("hidden");
        enableButton("btn-extract");
      }, 500);
    }

    function extractFeatures() {
      addLog(">>> Running ResNet-50 backbone...", "info");
      setTimeout(() => {
        addLog("‚úì Feature extraction completed [2, 2048, 25, 42]", "success");
        document.getElementById("stage-features").classList.remove("hidden");
        enableButton("btn-encoder");
      }, 800);
    }

    function runEncoder() {
      addLog(">>> Running Transformer Encoder (6 layers)...", "info");
      const grid = document.getElementById("attention-grid");
      grid.innerHTML = "";
      for (let i = 0; i < 64; i++) {
        const intensity = Math.random();
        grid.innerHTML += `<div class="w-6 h-6 rounded" style="background:rgba(59,130,246,${intensity})"></div>`;
      }
      setTimeout(() => {
        addLog("‚úì Encoder completed - self-attention applied", "success");
        document.getElementById("stage-encoder").classList.remove("hidden");
        enableButton("btn-decoder");
      }, 1000);
    }

    function runDecoder() {
      addLog(">>> Running Decoder with 300 object queries...", "info");
      const display = document.getElementById("queries-display");
      const emojis = ["üöó", "üö∂", "üö¥", "üöå", "üèçÔ∏è", "üöõ"];
      display.innerHTML = "";
      for (let i = 0; i < 30; i++) {
        const e = emojis[Math.floor(Math.random() * emojis.length)];
        display.innerHTML += `<span class="text-lg">${e}</span>`;
      }
      setTimeout(() => {
        addLog("‚úì Decoder completed - predictions generated", "success");
        document.getElementById("predictions-display").innerHTML = `
                    <div class="bg-white p-3 rounded border text-sm">
                        <p><strong>Source:</strong> 5 cars, 7 persons detected (high confidence)</p>
                        <p><strong>Target:</strong> 3 cars, 4 persons detected <span class="text-amber-600">(lower confidence - domain gap!)</span></p>
                    </div>`;
        document.getElementById("stage-decoder").classList.remove("hidden");
        enableButton("btn-cpa");
      }, 1200);
    }

    function runCPA() {
      addLog(">>> Extracting class-wise prototypes...", "info");
      const classes = ["car", "person", "bike", "bus", "motor", "truck"];
      let html = '<div class="grid grid-cols-3 gap-2">';
      classes.forEach((c) => {
        html += `<div class="bg-white border p-2 rounded text-center text-xs"><strong>${c}</strong><br>Src: ${Math.floor(Math.random() * 5) + 2
          } | Tgt: ${Math.floor(Math.random() * 4) + 1}</div>`;
      });
      html += "</div>";
      document.getElementById("prototypes-visual").innerHTML = html;
      setTimeout(() => {
        addLog("‚úì CPA: Adversarial loss = 0.452", "success");
        document.getElementById("stage-cpa").classList.remove("hidden");
        enableButton("btn-das");
      }, 1500);
    }

    function runDAS() {
      addLog(">>> Updating memory module...", "info");
      document.getElementById("memory-visual").innerHTML = `
                <div class="flex items-center justify-center gap-4 text-sm">
                    <div class="bg-white border p-3 rounded text-center"><strong>Memory Bank</strong><br>${simulationData.samplesProcessed + 150
        } samples</div>
                    <span class="text-xl">‚Üí</span>
                    <div class="bg-white border p-3 rounded text-center"><strong>Dataset Prototypes</strong><br>[8, 256]</div>
                </div>`;
      setTimeout(() => {
        const classes = ["car", "person", "bike", "bus", "motor", "truck"];
        let html =
          '<table class="w-full text-xs border-collapse"><tr><th class="border p-1"></th>';
        classes.forEach((c) => (html += `<th class="border p-1">${c}</th>`));
        html += "</tr>";
        classes.forEach((r, i) => {
          html += `<tr><th class="border p-1">${r}</th>`;
          classes.forEach((c, j) => {
            const v =
              i === j
                ? (0.8 + Math.random() * 0.15).toFixed(2)
                : (0.1 + Math.random() * 0.2).toFixed(2);
            const bg =
              i === j ? "bg-green-500 text-white" : "bg-red-400 text-white";
            html += `<td class="border p-1 text-center ${bg}">${v}</td>`;
          });
          html += "</tr>";
        });
        html += "</table>";
        document.getElementById("contrastive-matrix").innerHTML = html;
        addLog("‚úì DAS: Contrastive loss = 0.285", "success");
        document.getElementById("stage-das").classList.remove("hidden");
        enableButton("btn-loss");
      }, 1200);
    }

    function computeLoss() {
      addLog(">>> Computing total loss...", "info");
      const L_det = (1 + Math.random() * 0.5).toFixed(4);
      const L_adv = (0.3 + Math.random() * 0.2).toFixed(4);
      const L_con = (0.2 + Math.random() * 0.15).toFixed(4);
      const L_total = (
        parseFloat(L_det) +
        0.1 * parseFloat(L_adv) +
        0.1 * parseFloat(L_con)
      ).toFixed(4);
      setTimeout(() => {
        document.getElementById("loss-breakdown").innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                        <div class="bg-blue-100 p-3 rounded"><div class="text-lg font-bold text-blue-700">${L_det}</div><div class="text-xs">L_det</div></div>
                        <div class="bg-purple-100 p-3 rounded"><div class="text-lg font-bold text-purple-700">${(
            L_adv * 0.1
          ).toFixed(
            4
          )}</div><div class="text-xs">L_adv√ó0.1</div></div>
                        <div class="bg-cyan-100 p-3 rounded"><div class="text-lg font-bold text-cyan-700">${(
            L_con * 0.1
          ).toFixed(
            4
          )}</div><div class="text-xs">L_con√ó0.1</div></div>
                        <div class="bg-red-100 p-3 rounded"><div class="text-xl font-bold text-red-700">${L_total}</div><div class="text-xs">Total</div></div>
                    </div>`;
        document.getElementById("stage-loss").classList.remove("hidden");
        simulationData.epoch =
          Math.floor(simulationData.samplesProcessed / 100) + 1;
        simulationData.totalLoss = parseFloat(L_total);
        simulationData.mAP = Math.min(
          52.8,
          35.6 + simulationData.epoch * 0.8
        );
        simulationData.samplesProcessed += 2;
        updateStats();
        addLog("‚úì Training iteration completed!", "success");
        addLog(
          `Epoch: ${simulationData.epoch
          } | Loss: ${L_total} | mAP: ${simulationData.mAP.toFixed(1)}%`,
          "warning"
        );
      }, 1000);
    }

    function updateStats() {
      document.getElementById("stat-epoch").textContent =
        simulationData.epoch;
      document.getElementById("stat-loss").textContent =
        simulationData.totalLoss.toFixed(3);
      document.getElementById("stat-map").textContent =
        simulationData.mAP.toFixed(1) + "%";
      document.getElementById("stat-samples").textContent =
        simulationData.samplesProcessed;
    }

    function resetSimulation() {
      currentStep = 0;
      document.getElementById("status-display").innerHTML =
        '<div class="text-green-400">>>> System Reset. Ready...</div>';
      [
        "stage-input",
        "stage-features",
        "stage-encoder",
        "stage-decoder",
        "stage-cpa",
        "stage-das",
        "stage-loss",
      ].forEach((id) => {
        document.getElementById(id).classList.add("hidden");
      });
      [
        "btn-extract",
        "btn-encoder",
        "btn-decoder",
        "btn-cpa",
        "btn-das",
        "btn-loss",
      ].forEach((id) => {
        document.getElementById(id).disabled = true;
      });
    }

    function switchTab(e, tabId) {
      document
        .querySelectorAll(".tab-btn")
        .forEach((btn) =>
          btn.classList.replace("bg-primary-700", "bg-stone-300")
        );
      document
        .querySelectorAll(".tab-btn")
        .forEach((btn) =>
          btn.classList.replace("text-white", "text-primary-700")
        );
      e.target.classList.replace("bg-stone-300", "bg-primary-700");
      e.target.classList.replace("text-primary-700", "text-white");
      document
        .querySelectorAll(".tab-content")
        .forEach((c) => c.classList.add("hidden"));
      document.getElementById(tabId).classList.remove("hidden");
    }

    // Stage animation
    let stageIdx = 0;
    setInterval(() => {
      document
        .querySelectorAll(".stage")
        .forEach((s) => s.classList.remove("bg-primary-700", "text-white"));
      document
        .querySelectorAll(".stage")
        .forEach((s) => s.classList.add("bg-stone-200", "text-primary-700"));
      const stages = document.querySelectorAll(".stage");
      stages[stageIdx].classList.remove("bg-stone-200", "text-primary-700");
      stages[stageIdx].classList.add("bg-primary-700", "text-white");
      stageIdx = (stageIdx + 1) % stages.length;
    }, 3000);

    // ===== EASY SIMULATION - D·ªÑ HI·ªÇU =====
    function startEasySimulation() {
      const output = document.getElementById("easy-simulation-output");
      let html = "";

      // Step 1
      html += `
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-blue-700 mb-2">üì∏ B∆∞·ªõc 1: ƒê∆∞a ·∫¢nh V√†o (Input)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ Ch√∫ng ta c√≥ 2 lo·∫°i ·∫£nh:</strong></p>
              <ul class="list-disc list-inside space-y-1 ml-2">
                <li><span class="text-blue-600 font-semibold">Source domain (·∫£nh ng√†y):</span> ·∫¢nh ban ng√†y, r√µ r√†ng (d√πng ƒë·ªÉ hu·∫•n luy·ªán)</li>
                <li><span class="text-red-600 font-semibold">Target domain (·∫£nh s∆∞∆°ng m√π):</span> ·∫¢nh s∆∞∆°ng m√π, m·ªù (d√πng ƒë·ªÉ test th·ª±c t·∫ø)</li>
              </ul>
              <div class="bg-white p-3 rounded border-2 border-blue-300 mt-2">
                <strong>üíæ K√≠ch th∆∞·ªõc ·∫£nh:</strong> 2 ·∫£nh √ó 3 channels (RGB) √ó 800 √ó 1333 pixels
              </div>
            </div>
          </div>
        `;

      // Step 2
      html += `
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-orange-700 mb-2">üîç B∆∞·ªõc 2: Tr√≠ch Xu·∫•t ƒê·∫∑c Tr∆∞ng (Features)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ D√πng m√¥ h√¨nh ResNet-50:</strong> N√≥ gi·ªëng nh∆∞ m·ªôt m√°y l·ªçc ·∫£nh, gi·∫£m k√≠ch th∆∞·ªõc ·∫£nh nh∆∞ng gi·ªØ l·∫°i nh·ªØng th√¥ng tin quan tr·ªçng.</p>
              <div class="bg-white p-3 rounded border-2 border-orange-300 mt-2">
                <div class="space-y-1 font-mono text-xs">
                  <div><strong>·∫¢nh g·ªëc:</strong> 800 √ó 1333 pixels</div>
                  <div><strong>Qua ResNet-50:</strong> Gi·∫£m 32 l·∫ßn</div>
                  <div><strong>‚Üí Features k·∫øt qu·∫£:</strong> 25 √ó 42 √ó 2048 (m·ªói v·ªã tr√≠ c√≥ 2048 "ƒë·∫∑c ƒëi·ªÉm")</div>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>Gi·ªëng nh∆∞ b·∫°n ch·ª•p ·∫£nh sau ƒë√≥ v·∫Ω l·∫°i b·∫±ng nh·ªØng n√©t v·∫Ω r·∫•t t√≥m t·∫Øt nh∆∞ng v·∫´n gi·ªØ l·∫°i ƒë·∫∑c ƒëi·ªÉm ch√≠nh</em></p>
            </div>
          </div>
        `;

      // Step 3
      html += `
          <div class="bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-purple-700 mb-2">üéØ B∆∞·ªõc 3: T√¨m V·∫≠t Th·ªÉ (Detection)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ M√¥ h√¨nh d√πng 300 "Object Queries":</strong> Gi·ªëng nh∆∞ 300 c√¢y ƒë∆∞·ªùng th·∫≥ng qu√©t qua ·∫£nh, c·ªë g·∫Øng t√¨m v·∫≠t th·ªÉ.</p>
              <div class="bg-white p-3 rounded border-2 border-purple-300 mt-2">
                <p><strong>V·ªõi m·ªói "query":</strong></p>
                <ul class="list-disc list-inside mt-2 ml-2 space-y-1">
                  <li><strong>D·ª± ƒëo√°n class:</strong> "C√°i n√†y l√† car? Hay person? Hay bike?"</li>
                  <li><strong>D·ª± ƒëo√°n v·ªã tr√≠:</strong> "N√≥ ·ªü ƒë√¢u tr√™n ·∫£nh? (x, y, chi·ªÅu r·ªông, chi·ªÅu cao)"</li>
                </ul>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>Gi·ªëng nh∆∞ b·∫°n c√≥ 300 b·∫°n b√®, m·ªói ng∆∞·ªùi ch·ªâ tay v√†o 1 v·ªã tr√≠ v√† n√≥i "t√¥i th·∫•y 1 c√°i xe ·ªü ƒë√¢y"</em></p>
            </div>
          </div>
        `;

      // Step 4
      html += `
          <div class="bg-gradient-to-r from-pink-50 to-pink-100 border-l-4 border-pink-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-pink-700 mb-2">ü§ù B∆∞·ªõc 4: T√≠nh "Ch·ª©ng Ch·ªâ" C·ªßa T·ª´ng Lo·∫°i (Prototypes)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ T·∫≠p h·ª£p d·ª± ƒëo√°n c·ªßa c√πng 1 lo·∫°i:</strong></p>
              <div class="bg-white p-3 rounded border-2 border-pink-300 mt-2">
                <p class="mb-2"><strong>V√≠ d·ª•:</strong></p>
                <ul class="list-disc list-inside ml-2 space-y-1 text-xs">
                  <li>45 queries n√≥i "ƒê√≥ l√† <strong>car</strong>" ‚Üí L·∫•y trung b√¨nh 45 c√°i ƒë√≥ ‚Üí ƒë∆∞·ª£c "Ch·ª©ng Ch·ªâ Car"</li>
                  <li>30 queries n√≥i "ƒê√≥ l√† <strong>person</strong>" ‚Üí L·∫•y trung b√¨nh 30 c√°i ƒë√≥ ‚Üí ƒë∆∞·ª£c "Ch·ª©ng Ch·ªâ Person"</li>
                  <li>L√†m v·∫≠y cho t·∫•t c·∫£ ~10 lo·∫°i v·∫≠t th·ªÉ</li>
                </ul>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>"Ch·ª©ng Ch·ªâ" n√†y ƒë·∫°i di·ªán cho c√°i g√¨ l√† CAR, c√°i g√¨ l√† PERSON, v.v.</em></p>
            </div>
          </div>
        `;

      // Step 5
      html += `
          <div class="bg-gradient-to-r from-cyan-50 to-cyan-100 border-l-4 border-cyan-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-cyan-700 mb-2">‚öñÔ∏è B∆∞·ªõc 5: CƒÉn Ch·ªânh (Alignment)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ V·∫•n ƒë·ªÅ:</strong> "Ch·ª©ng Ch·ªâ Car" t·ª´ ·∫£nh ng√†y kh√°c v·ªõi "Ch·ª©ng Ch·ªâ Car" t·ª´ ·∫£nh s∆∞∆°ng m√π!</p>
              <div class="bg-white p-3 rounded border-2 border-cyan-300 mt-2">
                <p class="font-semibold text-cyan-700">Gi·∫£i ph√°p DATR:</p>
                <ul class="list-disc list-inside ml-2 mt-2 space-y-1 text-xs">
                  <li><strong>CPA Module:</strong> D√πng "Discriminator" ƒë·ªÉ ki·ªÉm tra "Ch·ª©ng Ch·ªâ" l√† t·ª´ ng√†y hay s∆∞∆°ng m√π, r·ªìi bu·ªôc ch√∫ng gi·ªëng nhau</li>
                  <li><strong>DAS Scheme:</strong> T√≠ch l≈©y "Ch·ª©ng Ch·ªâ" t·ª´ nhi·ªÅu batch, h·ªçc t·ª´ to√†n b·ªô dataset</li>
                </ul>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>Gi·ªëng nh∆∞ b·∫°n c·ªë g·∫Øng l√†m cho ch·ª©ng ch·ªâ car t·ª´ ·∫£nh ng√†y v√† s∆∞∆°ng m√π gi·ªëng h·ªát nhau</em></p>
            </div>
          </div>
        `;

      // Step 6
      html += `
          <div class="bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-green-700 mb-2">üë®‚Äçüè´ B∆∞·ªõc 6: H·ªçc T·ª´ Teacher (Mean-Teacher)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ 2 m√¥ h√¨nh l√†m vi·ªác c√πng nhau:</strong></p>
              <div class="grid grid-cols-2 gap-3 mt-2">
                <div class="bg-blue-50 p-3 rounded border border-blue-400">
                  <p class="font-bold text-blue-600">üë∂ Student</p>
                  <ul class="text-xs mt-1 space-y-0.5">
                    <li>H·ªçc t·ª´:</li>
                    <li>‚úì ·∫¢nh g·ªëc (ng√†y)</li>
                    <li>‚úì ·∫¢nh s∆∞∆°ng m√π</li>
                    <li>‚úì L·ªùi khuy√™n t·ª´ Teacher</li>
                  </ul>
                </div>
                <div class="bg-amber-50 p-3 rounded border border-amber-400">
                  <p class="font-bold text-amber-600">üë®‚Äçüè´ Teacher</p>
                  <ul class="text-xs mt-1 space-y-0.5">
                    <li>L√†m g√¨:</li>
                    <li>‚úì Copy t·ª´ Student (99.9%)</li>
                    <li>‚úì Cho ƒëi·ªÉm ·∫£nh s∆∞∆°ng m√π</li>
                    <li>‚úì H∆∞·ªõng d·∫´n Student</li>
                  </ul>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>L·∫∑p ƒëi l·∫∑p l·∫°i: Student h·ªçc ‚Üí Teacher sao ch√©p ‚Üí Student h·ªçc t·ª´ l·ªùi khuy√™n ‚Üí m√¥ h√¨nh ng√†y c√†ng th√¥ng minh</em></p>
            </div>
          </div>
        `;

      // Final Result
      html += `
          <div class="bg-gradient-to-r from-yellow-50 to-red-50 border-2 border-red-500 p-4 rounded-lg">
            <h3 class="text-lg font-bold text-red-700 mb-3">üìä K·∫øt Qu·∫£ Cu·ªëi C√πng</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white p-3 rounded border-l-4 border-red-500">
                <p class="text-xs text-gray-600">Baseline (ch·ªâ ng√†y)</p>
                <p class="text-2xl font-bold text-red-500">35.6%</p>
                <p class="text-xs text-gray-500">mAP</p>
              </div>
              <div class="bg-white p-3 rounded border-l-4 border-green-500">
                <p class="text-xs text-gray-600">DATR (ng√†y + s∆∞∆°ng m√π)</p>
                <p class="text-2xl font-bold text-green-600">52.8%</p>
                <p class="text-xs text-gray-500">mAP (+17.2% üéâ)</p>
              </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-3 rounded mt-3 border border-orange-300">
              <p class="text-sm font-semibold text-orange-700">üèÜ K·∫øt Lu·∫≠n:</p>
              <p class="text-xs text-orange-700 mt-1">DATR gi√∫p m√¥ h√¨nh t·ª´ <strong>35.6%</strong> ch√≠nh x√°c tr√™n ·∫£nh s∆∞∆°ng m√π tƒÉng l√™n <strong>52.8%</strong> - tƒÉng <strong>17.2 ƒëi·ªÉm ph·∫ßn trƒÉm!</strong></p>
            </div>
          </div>
        `;

      output.innerHTML = html;
    }

    // ===== DETAILED STEP BY STEP WITH ACTUAL DATA FLOW =====
    function startDetailedStepByStep() {
      const output = document.getElementById("detailed-step-output");
      let html = "";

      // ===== STEP 1: LOAD IMAGE =====
      html += `
          <div class="bg-gradient-to-br from-blue-100 to-blue-50 border-2 border-blue-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-blue-700 mb-3">üì∏ STEP 1: LOAD IMAGE (T·∫£i ·∫¢nh)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-blue-300">
              <p class="text-sm font-semibold text-blue-700 mb-2">üé¨ Qu√° tr√¨nh t·∫£i ·∫£nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><span class="text-green-700">‚úì</span> T√≠nh nƒÉng: ƒê·ªçc file ·∫£nh t·ª´ disk</div>
                <div><span class="text-green-700">‚úì</span> ƒê·∫ßu v√†o: "dog.jpg" (1 b·ª©c ·∫£nh th·ª±c t·∫ø)</div>
                <div><span class="text-green-700">‚úì</span> K√≠ch th∆∞·ªõc g·ªëc: 800 √ó 1333 pixels</div>
                <div><span class="text-green-700">‚úì</span> Channels: 3 (Red, Green, Blue)</div>
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-blue-700">Gi√° tr·ªã pixel:</strong></div>
                <div class="text-gray-700">Pixel (0,0): [R=125, G=145, B=160] (m√†u x√°m xanh)</div>
                <div class="text-gray-700">Pixel (10,20): [R=200, G=210, B=220] (m√†u x√°m s√°ng)</div>
                <div class="text-gray-700">... (c√≤n 1,066,399 pixels kh√°c) ...</div>
              </div>
            </div>

            <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-500">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 1:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>Tensor h√¨nh ·∫£nh</strong><br>
                Shape: <span class="text-blue-600">[1, 3, 800, 1333]</span><br>
                <span class="text-gray-600">1 ·∫£nh √ó 3 channels √ó 800 height √ó 1333 width</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 2: RESIZE IMAGE =====
      html += `
          <div class="bg-gradient-to-br from-orange-100 to-orange-50 border-2 border-orange-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-orange-700 mb-3">üîÑ STEP 2: RESIZE IMAGE (Chu·∫©n H√≥a K√≠ch Th∆∞·ªõc)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-orange-300">
              <p class="text-sm font-semibold text-orange-700 mb-2">‚öôÔ∏è Qu√° tr√¨nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong>Input t·ª´ Step 1:</strong> [1, 3, 800, 1333]</div>
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-orange-700">Ph√©p t√≠nh:</strong></div>
                <div><span class="text-green-700">‚Üí</span> Gi·ªØ t·ªâ l·ªá aspect ratio</div>
                <div><span class="text-green-700">‚Üí</span> Padding ƒë·ªÉ th√†nh h√¨nh ch·ªØ nh·∫≠t ƒë√∫ng chu·∫©n</div>
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-orange-700">C√¥ng th·ª©c:</strong></div>
                <div>Height √ó Width = 800 √ó 1333 = 1,066,400 pixels</div>
              </div>
            </div>

            <div class="bg-orange-50 p-3 rounded border-l-4 border-orange-500">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 2:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>·∫¢nh ƒë√£ chu·∫©n h√≥a</strong><br>
                Shape: <span class="text-orange-600">[1, 3, 800, 1333]</span><br>
                <span class="text-gray-600">Pixel values: [0-255] (v·∫´n gi·ªØ nguy√™n)</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 3: EXTRACT FEATURES V·ªöI RESNET-50 =====
      html += `
          <div class="bg-gradient-to-br from-purple-100 to-purple-50 border-2 border-purple-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-purple-700 mb-3">üß† STEP 3: EXTRACT FEATURES (ResNet-50 Backbone)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-purple-300">
              <p class="text-sm font-semibold text-purple-700 mb-2">üîç ResNet-50 l√†m g√¨:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong class="text-purple-700">Input:</strong> [1, 3, 800, 1333] (·∫£nh v·ªõi pixel 0-255)</div>
                
                <div class="mt-3 border-t border-gray-400 pt-2"><strong class="text-purple-700">Stage 1 (Conv 1):</strong></div>
                <div><span class="text-green-700">‚Üí</span> 7√ó7 convolution, stride 2</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1, 64, 400, 667]</div>
                <div class="text-gray-600 ml-4">Gi·∫£m k√≠ch th∆∞·ªõc 2x, tƒÉng filters t·ª´ 3 ‚Üí 64</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-purple-700">Stage 2 (Res Block 1):</strong></div>
                <div><span class="text-green-700">‚Üí</span> 3√ó3 convolutions (no stride)</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1, 256, 400, 667]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-purple-700">Stage 3 (Res Block 2):</strong></div>
                <div><span class="text-green-700">‚Üí</span> Stride 2 pooling</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1, 512, 200, 334]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-purple-700">Stage 4 (Res Block 3):</strong></div>
                <div><span class="text-green-700">‚Üí</span> Stride 2 pooling</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1, 1024, 100, 167]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-purple-700">Stage 5 (Res Block 4):</strong></div>
                <div><span class="text-green-700">‚Üí</span> Stride 2 pooling + Final layer</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1, 2048, 25, 42]</div>
                <div class="text-gray-600 ml-4">T·ªïng stride = 32x (800/32=25, 1333/32‚âà42)</div>
              </div>
            </div>

            <div class="bg-purple-50 p-4 rounded border-l-4 border-purple-500">
              <p class="text-sm font-semibold text-purple-700 mb-2">üí° C√°ch Hi·ªÉu:</p>
              <p class="text-xs text-purple-700 mb-2">ResNet-50 c√≥ th·ªÉ h√¨nh dung nh∆∞:</p>
              <ul class="text-xs list-disc list-inside space-y-1 text-purple-700">
                <li><strong>Input:</strong> ·∫¢nh 800√ó1333 v·ªõi 3 channels RGB</li>
                <li><strong>Process:</strong> ƒêi qua 5 stage, m·ªói stage "gi·∫£m k√≠ch th∆∞·ªõc nh∆∞ng tƒÉng ƒë·ªô s√¢u"</li>
                <li><strong>Output:</strong> M·ªói v·ªã tr√≠ nh·ªè (25√ó42 = 1,050 v·ªã tr√≠) c√≥ 2048 "ƒë·∫∑c tr∆∞ng"</li>
                <li><strong>√ù nghƒ©a:</strong> Thay v√¨ l∆∞u gi·ªØ 1,066,400 pixel values, ta l∆∞u 2,150,400 feature values</li>
              </ul>
            </div>

            <div class="bg-purple-50 p-3 rounded border-l-4 border-purple-500 mt-3">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 3:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>Feature Map t·ª´ ResNet-50</strong><br>
                Shape: <span class="text-purple-600">[1, 2048, 25, 42]</span><br>
                <span class="text-gray-600">1 ·∫£nh √ó 2048 features √ó 25 height √ó 42 width</span><br>
                <span class="text-gray-600">V√≠ d·ª•: Feature [i=10, j=20] = [0.34, 0.89, 0.12, ..., 0.65] (2048 gi√° tr·ªã)</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 4: TRANSFORMER ENCODER =====
      html += `
          <div class="bg-gradient-to-br from-cyan-100 to-cyan-50 border-2 border-cyan-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-cyan-700 mb-3">üîÑ STEP 4: TRANSFORMER ENCODER (Self-Attention)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-cyan-300">
              <p class="text-sm font-semibold text-cyan-700 mb-2">‚öôÔ∏è Qu√° tr√¨nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong class="text-cyan-700">Input:</strong> [1, 2048, 25, 42] t·ª´ ResNet-50</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-cyan-700">B∆∞·ªõc 1: Flatten + Project</strong></div>
                <div><span class="text-green-700">‚Üí</span> Flatten 25√ó42 = 1050 v·ªã tr√≠</div>
                <div><span class="text-green-700">‚Üí</span> Project 2048 ‚Üí 256 chi·ªÅu (Linear layer)</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1050, 1, 256]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-cyan-700">B∆∞·ªõc 2: Add Positional Encoding</strong></div>
                <div><span class="text-green-700">‚Üí</span> Th√™m v√†o th√¥ng tin "v·ªã tr√≠" ƒë·ªÉ transformer bi·∫øt v·ªã tr√≠ n√†o</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1050, 1, 256] (nh∆∞ng c√≥ th√™m th√¥ng tin v·ªã tr√≠)</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-cyan-700">B∆∞·ªõc 3: Self-Attention (6 layers)</strong></div>
                <div><span class="text-green-700">‚Üí</span> M·ªói v·ªã tr√≠ "nh√¨n" to√†n b·ªô 1050 v·ªã tr√≠ kh√°c</div>
                <div><span class="text-green-700">‚Üí</span> T·∫°o attention weights (c√°i n√†o quan tr·ªçng, c√°i n√†o kh√¥ng)</div>
                <div><span class="text-green-700">‚Üí</span> Output: [1050, 1, 256] (sau 6 layers)</div>
              </div>
            </div>

            <div class="bg-cyan-50 p-4 rounded border-l-4 border-cyan-500">
              <p class="text-sm font-semibold text-cyan-700 mb-2">üí° V√≠ D·ª•:</p>
              <p class="text-xs text-cyan-700 mb-2">V·ªã tr√≠ (10, 15) tr√™n ·∫£nh (m·ªôt v·ªã tr√≠ nh·ªè):</p>
              <ul class="text-xs list-disc list-inside space-y-1 text-cyan-700">
                <li><strong>Ban ƒë·∫ßu:</strong> [0.34, 0.89, ..., 0.65] (256 gi√° tr·ªã t·ª´ ResNet)</li>
                <li><strong>Sau attention:</strong> N√≥ "nh√¨n th·∫•y" r·∫±ng v·ªã tr√≠ (5,10) c√≥ con dog, n√™n c·∫≠p nh·∫≠t ƒë·ªÉ ph·∫£n √°nh ƒëi·ªÅu ƒë√≥</li>
                <li><strong>K·∫øt qu·∫£:</strong> [0.42, 0.91, ..., 0.68] (t∆∞∆°ng t·ª±, nh∆∞ng ƒë√£ ƒë∆∞·ª£c "c·∫£i thi·ªán")</li>
              </ul>
            </div>

            <div class="bg-cyan-50 p-3 rounded border-l-4 border-cyan-500 mt-3">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 4:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>Memory (Encoder Output)</strong><br>
                Shape: <span class="text-cyan-600">[1050, 1, 256]</span><br>
                <span class="text-gray-600">1050 v·ªã tr√≠ √ó 1 batch √ó 256 features (enhanced)</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 5: DECODER + OBJECT QUERIES =====
      html += `
          <div class="bg-gradient-to-br from-pink-100 to-pink-50 border-2 border-pink-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-pink-700 mb-3">üéØ STEP 5: DECODER + OBJECT QUERIES (T√¨m V·∫≠t Th·ªÉ)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-pink-300">
              <p class="text-sm font-semibold text-pink-700 mb-2">‚öôÔ∏è Qu√° tr√¨nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong class="text-pink-700">Input:</strong> Memory [1050, 1, 256] t·ª´ Encoder</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-pink-700">B∆∞·ªõc 1: Initialize Object Queries</strong></div>
                <div><span class="text-green-700">‚Üí</span> 300 queries (300 "c√¢y ƒë∆∞·ªùng th·∫≥ng" qu√©t qua ·∫£nh)</div>
                <div><span class="text-green-700">‚Üí</span> M·ªói query c√≥ 256 dimensions</div>
                <div><span class="text-green-700">‚Üí</span> Queries shape: [300, 1, 256]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-pink-700">B∆∞·ªõc 2: Decoder Cross-Attention (6 layers)</strong></div>
                <div><span class="text-green-700">‚Üí</span> M·ªói query "h·ªèi" memory: "B·∫°n c√≥ v·∫≠t th·ªÉ n√†o ·ªü ƒë√¢y kh√¥ng?"</div>
                <div><span class="text-green-700">‚Üí</span> Memory tr·∫£ l·ªùi b·∫±ng c√°ch t·∫°o attention weights</div>
                <div><span class="text-green-700">‚Üí</span> Output: [300, 1, 256]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-pink-700">B∆∞·ªõc 3: Prediction Heads</strong></div>
                <div><span class="text-green-700">‚Üí</span> Classification head: [300, 1, num_classes]</div>
                <div><span class="text-green-700">‚Üí</span> Bounding box head: [300, 1, 4] (x, y, width, height)</div>
              </div>
            </div>

            <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
              <p class="text-sm font-semibold text-pink-700 mb-2">üí° V√≠ D·ª• K·∫øt Qu·∫£:</p>
              <div class="text-xs bg-white p-2 rounded mt-2 space-y-1 text-pink-700">
                <div><strong>Query #5:</strong> "T√¥i th·∫•y 1 c√°i dog ·ªü v·ªã tr√≠ (0.3, 0.4) v·ªõi confidence 0.95"</div>
                <div><strong>Query #12:</strong> "T√¥i th·∫•y 1 c√°i car ·ªü v·ªã tr√≠ (0.6, 0.7) v·ªõi confidence 0.87"</div>
                <div><strong>Query #50:</strong> "T√¥i kh√¥ng th·∫•y g√¨ ·ªü ƒë√¢y" (background, confidence 0.05)</div>
                <div>... (c√≤n 297 queries kh√°c) ...</div>
              </div>
            </div>

            <div class="bg-pink-50 p-3 rounded border-l-4 border-pink-500 mt-3">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 5:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>Predictions</strong><br>
                Classes: <span class="text-pink-600">[300, num_classes]</span><br>
                Boxes: <span class="text-pink-600">[300, 4]</span><br>
                <span class="text-gray-600">300 d·ª± ƒëo√°n (query) √ó class scores / bounding boxes</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 6: COMPUTE PROTOTYPES (CPA) =====
      html += `
          <div class="bg-gradient-to-br from-green-100 to-green-50 border-2 border-green-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-green-700 mb-3">ü§ù STEP 6: COMPUTE CLASS PROTOTYPES (CPA)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-green-300">
              <p class="text-sm font-semibold text-green-700 mb-2">‚öôÔ∏è Qu√° tr√¨nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong class="text-green-700">Input:</strong> 300 queries + 300 class predictions</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-green-700">B∆∞·ªõc 1: Group by Class</strong></div>
                <div class="ml-4">
                  <div><span class="text-green-700">‚Üí</span> Query #5 ‚Üí class "dog" (confidence 0.95)</div>
                  <div><span class="text-green-700">‚Üí</span> Query #15 ‚Üí class "dog" (confidence 0.92)</div>
                  <div><span class="text-green-700">‚Üí</span> Query #23 ‚Üí class "dog" (confidence 0.88)</div>
                  <div><span class="text-green-700">‚Üí</span> ... (th√™m 42 queries n·ªØa cho class "dog") ...</div>
                  <div class="mt-1"><strong>Total 45 queries ‚Üí class "dog"</strong></div>
                </div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-green-700">B∆∞·ªõc 2: Average per Class</strong></div>
                <div class="ml-4">
                  <div>Prototype_dog = (Query_5 + Query_15 + ... + Query_299) / 45</div>
                  <div class="text-gray-600">= trung b√¨nh 45 vectors [256,] ‚Üí [256,]</div>
                  <div class="mt-1">Prototype_dog = [0.42, 0.91, 0.28, ..., 0.68] (256 gi√° tr·ªã)</div>
                </div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-green-700">L·∫∑p cho t·∫•t c·∫£ classes:</strong></div>
                <div class="ml-4">
                  <div><span class="text-green-700">‚Üí</span> Prototype_car (t·ª´ 40 queries)</div>
                  <div><span class="text-green-700">‚Üí</span> Prototype_person (t·ª´ 35 queries)</div>
                  <div><span class="text-green-700">‚Üí</span> Prototype_bike (t·ª´ 28 queries)</div>
                  <div><span class="text-green-700">‚Üí</span> ... (t·ªïng ~10 classes)</div>
                </div>
              </div>
            </div>

            <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
              <p class="text-sm font-semibold text-green-700 mb-2">üí° √ù Nghƒ©a:</p>
              <p class="text-xs text-green-700">Prototype_dog ƒë·∫°i di·ªán cho "c√°i g√¨ l√† m·ªôt con dog theo m√¥ h√¨nh"</p>
              <p class="text-xs text-green-700 mt-1">N√≥ l√† m·ªôt "ch·ª©ng ch·ªâ" trung b√¨nh c·ªßa t·∫•t c·∫£ nh·ªØng th·ª© m√¥ h√¨nh cho l√† dog</p>
            </div>

            <div class="bg-green-50 p-3 rounded border-l-4 border-green-500 mt-3">
              <p class="text-sm"><strong>üì§ Output c·ªßa Step 6:</strong></p>
              <div class="font-mono text-xs bg-white p-2 rounded mt-2 text-center">
                <strong>Class Prototypes</strong><br>
                Shape: <span class="text-green-600">[num_classes, 256]</span><br>
                <span class="text-gray-600">~10 classes √ó 256 features m·ªói class</span>
              </div>
            </div>
          </div>
        `;

      // ===== STEP 7: ALIGNMENT (RESULT) =====
      html += `
          <div class="bg-gradient-to-br from-yellow-100 to-yellow-50 border-2 border-yellow-500 rounded-lg p-5 mt-4">
            <h3 class="text-lg font-bold text-yellow-700 mb-3">üèÅ FINAL RESULT: M√¥ H√¨nh Nh·∫≠n Bi·∫øt ƒê∆∞·ª£c V·∫≠t Th·ªÉ!</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-yellow-300">
              <p class="text-sm font-semibold text-yellow-700 mb-2">üìä K·∫øt Qu·∫£ Cu·ªëi C√πng:</p>
              <div class="space-y-3">
                <div class="bg-yellow-50 p-2 rounded">
                  <p class="text-xs font-mono"><strong>Input:</strong> ·∫¢nh "dog_in_foggy_day.jpg"</p>
                  <p class="text-xs font-mono"><strong>Output:</strong> Danh s√°ch v·∫≠t th·ªÉ ƒë∆∞·ª£c ph√°t hi·ªán</p>
                </div>
                <div class="bg-white border border-yellow-200 p-2 rounded">
                  <p class="text-xs"><strong>Detection #1:</strong></p>
                  <div class="ml-4 text-xs font-mono">
                    <div>Class: dog (confidence: <span class="text-green-600">92%</span>)</div>
                    <div>Box: x=250, y=180, width=150, height=200</div>
                    <div>V·ªã tr√≠: "Con ch√≥ ·ªü gi·ªØa ·∫£nh, ph√≠a b√™n tr√°i"</div>
                  </div>
                </div>
                <div class="bg-white border border-yellow-200 p-2 rounded">
                  <p class="text-xs"><strong>Detection #2:</strong></p>
                  <div class="ml-4 text-xs font-mono">
                    <div>Class: car (confidence: <span class="text-green-600">87%</span>)</div>
                    <div>Box: x=600, y=350, width=200, height=120</div>
                    <div>V·ªã tr√≠: "C√°i xe ·ªü ph√≠a d∆∞·ªõi b√™n ph·∫£i"</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded border-2 border-green-500">
              <p class="text-sm font-bold text-green-700">‚úÖ Th√†nh C√¥ng!</p>
              <p class="text-xs text-green-700 mt-2">M√¥ h√¨nh ƒë√£ t·ª´ "nh√¨n th·∫•y pixel values" (Step 1) ‚Üí "hi·ªÉu ƒë∆∞·ª£c v·∫≠t th·ªÉ l√† g√¨" (Step 7)</p>
              <p class="text-xs text-green-700 mt-1">üìà T·ª´ 35.6% (ch·ªâ ·∫£nh ng√†y) ‚Üí 52.8% (·∫£nh ng√†y + s∆∞∆°ng m√π) = <strong>+17.2%!</strong></p>
            </div>
          </div>
        `;

      output.innerHTML = html;
    }

    // ========================================
    // ANIMATED SIMULATIONS WITH FORMULA SUBSTITUTION
    // ========================================

    // Helper function: Animate typing effect
    function typeText(element, text, speed = 30) {
      return new Promise((resolve) => {
        let i = 0;
        element.textContent = '';
        const timer = setInterval(() => {
          element.textContent += text.charAt(i);
          i++;
          if (i >= text.length) {
            clearInterval(timer);
            resolve();
          }
        }, speed);
      });
    }

    // Helper function: Animate number counting
    function animateNumber(element, start, end, duration = 1000, suffix = '') {
      return new Promise((resolve) => {
        const startTime = Date.now();
        const range = end - start;
        const timer = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const current = start + range * progress;
          element.textContent = (Math.round(current * 100) / 100) + suffix;
          if (progress >= 1) {
            clearInterval(timer);
            resolve();
          }
        }, 16);
      });
    }

    // Helper function: Sleep
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // Helper function: Add step with animation
    async function addStepWithAnimation(container, stepHtml, delay = 500) {
      const stepDiv = document.createElement('div');
      stepDiv.innerHTML = stepHtml;
      stepDiv.style.opacity = '0';
      stepDiv.style.transform = 'translateY(20px)';
      stepDiv.style.transition = 'all 0.5s ease-out';
      container.appendChild(stepDiv);

      await sleep(100);
      stepDiv.style.opacity = '1';
      stepDiv.style.transform = 'translateY(0)';

      await sleep(delay);
      return stepDiv;
    }

    // ===== EASY SIMULATION WITH ANIMATION =====
    let easySimulationRunning = false;

    async function startEasySimulationAnimated() {
      if (easySimulationRunning) return;
      easySimulationRunning = true;

      const output = document.getElementById("easy-simulation-output");
      output.innerHTML = "";

      // Show progress bar and reset button
      document.getElementById("easy-progress-container").classList.remove("hidden");
      document.getElementById("easy-reset-btn").classList.remove("hidden");

      const progressBar = document.getElementById("easy-progress-bar");
      const progressText = document.getElementById("easy-progress-text");

      const totalSteps = 7;
      let currentStep = 0;

      const updateProgress = () => {
        currentStep++;
        const percent = (currentStep / totalSteps) * 100;
        progressBar.style.width = percent + '%';
        progressText.textContent = `${currentStep}/${totalSteps} b∆∞·ªõc`;
      };

      // ===== STEP 1: INPUT =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-blue-700 mb-2">üì∏ B∆∞·ªõc 1: ƒê∆∞a ·∫¢nh V√†o (Input)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ Ch√∫ng ta c√≥ 2 lo·∫°i ·∫£nh:</strong></p>
              <ul class="list-disc list-inside space-y-1 ml-2">
                <li><span class="text-blue-600 font-semibold">Source domain (·∫£nh ng√†y):</span> ·∫¢nh ban ng√†y, r√µ r√†ng (d√πng ƒë·ªÉ hu·∫•n luy·ªán)</li>
                <li><span class="text-red-600 font-semibold">Target domain (·∫£nh s∆∞∆°ng m√π):</span> ·∫¢nh s∆∞∆°ng m√π, m·ªù (d√πng ƒë·ªÉ test th·ª±c t·∫ø)</li>
              </ul>
              
              <!-- Formula Substitution Animation for Pixel Count -->
              <div class="bg-white p-3 rounded border-2 border-blue-300 mt-2">
                <strong>üíæ T√≠nh t·ªïng s·ªë pixels:</strong>
                <div class="mt-2 font-mono text-sm">
                  <div class="text-gray-600">C√¥ng th·ª©c: Batch √ó Channels √ó Height √ó Width</div>
                  <div class="text-blue-700 mt-1">= <span class="bg-yellow-200 px-1">2</span> √ó <span class="bg-yellow-200 px-1">3</span> √ó <span class="bg-yellow-200 px-1">800</span> √ó <span class="bg-yellow-200 px-1">1333</span></div>
                  <div class="text-green-700 font-bold mt-1" id="easy-step1-result">= ƒêang t√≠nh...</div>
                </div>
              </div>
            </div>
          </div>
        `, 300);

      // Animate the calculation
      await sleep(500);
      const step1Result = document.getElementById("easy-step1-result");
      step1Result.innerHTML = '= <span class="bg-green-200 px-2 py-1 rounded">6,399,200</span> pixel values';

      await sleep(800);

      // ===== STEP 2: FEATURES =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-orange-700 mb-2">üîç B∆∞·ªõc 2: Tr√≠ch Xu·∫•t ƒê·∫∑c Tr∆∞ng (Features)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ D√πng m√¥ h√¨nh ResNet-50:</strong> Gi·ªëng nh∆∞ m·ªôt m√°y l·ªçc ·∫£nh, gi·∫£m k√≠ch th∆∞·ªõc nh∆∞ng gi·ªØ l·∫°i th√¥ng tin quan tr·ªçng.</p>
              
              <!-- Formula Substitution for Feature Extraction -->
              <div class="bg-white p-3 rounded border-2 border-orange-300 mt-2">
                <strong>‚öôÔ∏è C√¥ng th·ª©c t√≠nh k√≠ch th∆∞·ªõc output:</strong>
                <div class="mt-2 font-mono text-sm">
                  <div class="text-gray-600">Output Height = Input Height √∑ Stride</div>
                  <div class="text-orange-700 mt-1">= <span class="bg-yellow-200 px-1">800</span> √∑ <span class="bg-yellow-200 px-1">32</span> = <span class="bg-green-200 px-1 font-bold" id="easy-step2-h">?</span></div>
                  
                  <div class="text-gray-600 mt-2">Output Width = Input Width √∑ Stride</div>
                  <div class="text-orange-700 mt-1">= <span class="bg-yellow-200 px-1">1333</span> √∑ <span class="bg-yellow-200 px-1">32</span> = <span class="bg-green-200 px-1 font-bold" id="easy-step2-w">?</span></div>
                  
                  <div class="text-gray-600 mt-2">Feature Map Shape:</div>
                  <div class="text-green-700 font-bold mt-1" id="easy-step2-result">[?, ?, ?, ?]</div>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>Gi·ªëng nh∆∞ b·∫°n ch·ª•p ·∫£nh sau ƒë√≥ v·∫Ω l·∫°i b·∫±ng nh·ªØng n√©t v·∫Ω r·∫•t t√≥m t·∫Øt nh∆∞ng v·∫´n gi·ªØ l·∫°i ƒë·∫∑c ƒëi·ªÉm ch√≠nh</em></p>
            </div>
          </div>
        `, 300);

      await sleep(500);
      await animateNumber(document.getElementById("easy-step2-h"), 0, 25, 500, '');
      await animateNumber(document.getElementById("easy-step2-w"), 0, 42, 500, '');
      document.getElementById("easy-step2-result").innerHTML = '[<span class="bg-green-200 px-1">2</span>, <span class="bg-green-200 px-1">2048</span>, <span class="bg-green-200 px-1">25</span>, <span class="bg-green-200 px-1">42</span>]';

      await sleep(800);

      // ===== STEP 3: DETECTION =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-purple-700 mb-2">üéØ B∆∞·ªõc 3: T√¨m V·∫≠t Th·ªÉ (Detection)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ M√¥ h√¨nh d√πng 300 "Object Queries":</strong> Gi·ªëng nh∆∞ 300 c√¢y ƒë∆∞·ªùng th·∫≥ng qu√©t qua ·∫£nh, c·ªë g·∫Øng t√¨m v·∫≠t th·ªÉ.</p>
              
              <div class="bg-white p-3 rounded border-2 border-purple-300 mt-2">
                <strong>üìä K·∫øt qu·∫£ Detection:</strong>
                <div class="mt-2 grid grid-cols-2 gap-2 font-mono text-xs">
                  <div class="bg-purple-50 p-2 rounded">
                    <div class="text-purple-700">Query #5: üöó Car</div>
                    <div>Confidence: <span id="easy-step3-conf1" class="font-bold text-green-600">0%</span></div>
                    <div>Box: [0.35, 0.42, 0.15, 0.12]</div>
                  </div>
                  <div class="bg-purple-50 p-2 rounded">
                    <div class="text-purple-700">Query #12: üö∂ Person</div>
                    <div>Confidence: <span id="easy-step3-conf2" class="font-bold text-green-600">0%</span></div>
                    <div>Box: [0.60, 0.55, 0.08, 0.25]</div>
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>Gi·ªëng nh∆∞ b·∫°n c√≥ 300 b·∫°n b√®, m·ªói ng∆∞·ªùi ch·ªâ tay v√†o 1 v·ªã tr√≠ v√† n√≥i "t√¥i th·∫•y 1 c√°i xe ·ªü ƒë√¢y"</em></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("easy-step3-conf1"), 0, 95, 800, '%');
      await animateNumber(document.getElementById("easy-step3-conf2"), 0, 87, 800, '%');

      await sleep(800);

      // ===== STEP 4: PROTOTYPES =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-pink-50 to-pink-100 border-l-4 border-pink-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-pink-700 mb-2">ü§ù B∆∞·ªõc 4: T√≠nh "Ch·ª©ng Ch·ªâ" C·ªßa T·ª´ng Lo·∫°i (Prototypes)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ C√¥ng th·ª©c t√≠nh Prototype:</strong></p>
              
              <div class="bg-white p-3 rounded border-2 border-pink-300 mt-2">
                <div class="text-center mb-3">
                  <strong class="text-pink-700">\\( P_c = \\frac{1}{N_c} \\sum_{i: class(q_i) = c} q_i \\)</strong>
                </div>
                
                <div class="font-mono text-xs space-y-2">
                  <div class="bg-pink-50 p-2 rounded">
                    <div><strong>Prototype_car:</strong></div>
                    <div>= (Query_5 + Query_23 + ... + Query_287) / <span id="easy-step4-n1" class="bg-yellow-200 px-1">?</span></div>
                    <div class="text-pink-700">= Vector [<span id="easy-step4-v1">...</span>] (256 dimensions)</div>
                  </div>
                  <div class="bg-pink-50 p-2 rounded">
                    <div><strong>Prototype_person:</strong></div>
                    <div>= (Query_12 + Query_45 + ... + Query_298) / <span id="easy-step4-n2" class="bg-yellow-200 px-1">?</span></div>
                    <div class="text-pink-700">= Vector [<span id="easy-step4-v2">...</span>] (256 dimensions)</div>
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° <em>"Ch·ª©ng Ch·ªâ" n√†y ƒë·∫°i di·ªán cho c√°i g√¨ l√† CAR, c√°i g√¨ l√† PERSON, v.v.</em></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("easy-step4-n1"), 0, 45, 600, '');
      await animateNumber(document.getElementById("easy-step4-n2"), 0, 38, 600, '');
      document.getElementById("easy-step4-v1").textContent = '0.42, 0.91, 0.28, ..., 0.68';
      document.getElementById("easy-step4-v2").textContent = '0.35, 0.82, 0.45, ..., 0.71';

      // Re-render MathJax
      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(800);

      // ===== STEP 5: ALIGNMENT =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-cyan-50 to-cyan-100 border-l-4 border-cyan-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-cyan-700 mb-2">‚öñÔ∏è B∆∞·ªõc 5: CƒÉn Ch·ªânh (Alignment)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ T√≠nh Adversarial Loss (CPA Module):</strong></p>
              
              <div class="bg-white p-3 rounded border-2 border-cyan-300 mt-2">
                <div class="text-center mb-3">
                  <strong class="text-cyan-700">\\( \\mathcal{L}_{adv} = BCE(D(GRL(P)), y_{domain}) \\)</strong>
                </div>
                
                <div class="font-mono text-xs space-y-2">
                  <div class="bg-cyan-50 p-2 rounded">
                    <div><strong>Discriminator predictions:</strong></div>
                    <div>- Source proto: D(P_src) = <span id="easy-step5-src">?</span></div>
                    <div>- Target proto: D(P_tgt) = <span id="easy-step5-tgt">?</span></div>
                    <div class="mt-2 border-t pt-2">
                      <strong>L_adv = </strong>BCE(<span class="bg-yellow-200 px-1">0.92</span>, 1) + BCE(<span class="bg-yellow-200 px-1">0.78</span>, 0)
                    </div>
                    <div class="text-cyan-700 font-bold">= <span id="easy-step5-loss">?</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("easy-step5-src"), 0, 0.92, 600, '');
      await animateNumber(document.getElementById("easy-step5-tgt"), 0, 0.78, 600, '');
      await animateNumber(document.getElementById("easy-step5-loss"), 0, 0.452, 800, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(800);

      // ===== STEP 6: MEAN-TEACHER =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-600 p-4 rounded-r-lg">
            <h3 class="text-lg font-bold text-green-700 mb-2">üë®‚Äçüè´ B∆∞·ªõc 6: H·ªçc T·ª´ Teacher (Mean-Teacher)</h3>
            <div class="space-y-2 text-sm">
              <p><strong>üëâ C√¥ng th·ª©c EMA Update:</strong></p>
              
              <div class="bg-white p-3 rounded border-2 border-green-300 mt-2">
                <div class="text-center mb-3">
                  <strong class="text-green-700">\\( \\theta_{teacher} \\leftarrow \\alpha \\cdot \\theta_{teacher} + (1-\\alpha) \\cdot \\theta_{student} \\)</strong>
                </div>
                
                <div class="font-mono text-xs space-y-2">
                  <div class="bg-green-50 p-2 rounded">
                    <div><strong>V·ªõi Œ± = 0.999:</strong></div>
                    <div class="mt-1">Œ∏_teacher = <span class="bg-yellow-200 px-1">0.999</span> √ó Œ∏_teacher_old + <span class="bg-yellow-200 px-1">0.001</span> √ó Œ∏_student</div>
                    <div class="mt-2">
                      <div>V√≠ d·ª• v·ªõi 1 weight:</div>
                      <div>= 0.999 √ó <span class="bg-blue-200 px-1">0.5234</span> + 0.001 √ó <span class="bg-purple-200 px-1">0.5289</span></div>
                      <div class="text-green-700 font-bold">= <span id="easy-step6-ema">?</span></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mt-3">
                <div class="bg-blue-50 p-3 rounded border border-blue-400 text-center">
                  <p class="font-bold text-blue-600">üë∂ Student</p>
                  <p class="text-xs mt-1">Loss: <span id="easy-step6-sloss" class="font-mono">?</span></p>
                </div>
                <div class="bg-amber-50 p-3 rounded border border-amber-400 text-center">
                  <p class="font-bold text-amber-600">üë®‚Äçüè´ Teacher</p>
                  <p class="text-xs mt-1">Updated weights: <span id="easy-step6-tweight" class="font-mono">?</span></p>
                </div>
              </div>
            </div>
          </div>
        `, 300);

      // Calculate EMA animation
      const emaResult = 0.999 * 0.5234 + 0.001 * 0.5289;
      await animateNumber(document.getElementById("easy-step6-ema"), 0, emaResult, 800, '');
      await animateNumber(document.getElementById("easy-step6-sloss"), 0, 1.245, 600, '');
      document.getElementById("easy-step6-tweight").textContent = '‚úì Updated';

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(800);

      // ===== STEP 7: FINAL RESULT =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-r from-yellow-50 to-red-50 border-2 border-red-500 p-4 rounded-lg">
            <h3 class="text-lg font-bold text-red-700 mb-3">üìä K·∫øt Qu·∫£ Cu·ªëi C√πng</h3>
            
            <div class="bg-white p-3 rounded border-2 border-red-300 mb-3">
              <div class="text-center mb-3">
                <strong class="text-red-700">\\( \\mathcal{L}_{total} = \\mathcal{L}_{det} + \\lambda_a \\mathcal{L}_{adv} + \\lambda_c \\mathcal{L}_{con} \\)</strong>
              </div>
              
              <div class="font-mono text-xs space-y-1">
                <div>= <span class="bg-blue-200 px-1" id="easy-step7-det">?</span> + 0.1 √ó <span class="bg-purple-200 px-1" id="easy-step7-adv">?</span> + 0.1 √ó <span class="bg-cyan-200 px-1" id="easy-step7-con">?</span></div>
                <div class="text-red-700 font-bold text-lg mt-2">= <span id="easy-step7-total">?</span></div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white p-3 rounded border-l-4 border-red-500">
                <p class="text-xs text-gray-600">Baseline (ch·ªâ ng√†y)</p>
                <p class="text-2xl font-bold text-red-500"><span id="easy-step7-baseline">0</span>%</p>
                <p class="text-xs text-gray-500">mAP</p>
              </div>
              <div class="bg-white p-3 rounded border-l-4 border-green-500">
                <p class="text-xs text-gray-600">DATR (ng√†y + s∆∞∆°ng m√π)</p>
                <p class="text-2xl font-bold text-green-600"><span id="easy-step7-datr">0</span>%</p>
                <p class="text-xs text-gray-500">mAP (+17.2% üéâ)</p>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-3 rounded mt-3 border border-orange-300">
              <p class="text-sm font-semibold text-orange-700">üèÜ K·∫øt Lu·∫≠n:</p>
              <p class="text-xs text-orange-700 mt-1">DATR gi√∫p m√¥ h√¨nh t·ª´ <strong>35.6%</strong> ch√≠nh x√°c tr√™n ·∫£nh s∆∞∆°ng m√π tƒÉng l√™n <strong>52.8%</strong> - tƒÉng <strong>17.2 ƒëi·ªÉm ph·∫ßn trƒÉm!</strong></p>
            </div>
          </div>
        `, 300);

      // Animate final results
      await animateNumber(document.getElementById("easy-step7-det"), 0, 1.245, 500, '');
      await animateNumber(document.getElementById("easy-step7-adv"), 0, 0.452, 500, '');
      await animateNumber(document.getElementById("easy-step7-con"), 0, 0.285, 500, '');

      const totalLoss = 1.245 + 0.1 * 0.452 + 0.1 * 0.285;
      await animateNumber(document.getElementById("easy-step7-total"), 0, totalLoss, 800, '');

      await animateNumber(document.getElementById("easy-step7-baseline"), 0, 35.6, 1000, '');
      await animateNumber(document.getElementById("easy-step7-datr"), 0, 52.8, 1000, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      easySimulationRunning = false;
    }

    function resetEasySimulation() {
      easySimulationRunning = false;
      document.getElementById("easy-simulation-output").innerHTML = "";
      document.getElementById("easy-progress-container").classList.add("hidden");
      document.getElementById("easy-reset-btn").classList.add("hidden");
      document.getElementById("easy-progress-bar").style.width = "0%";
      document.getElementById("easy-progress-text").textContent = "0/6 b∆∞·ªõc";
    }

    // ===== DETAILED STEP-BY-STEP WITH ANIMATION =====
    let detailedSimulationRunning = false;

    async function startDetailedStepByStepAnimated() {
      if (detailedSimulationRunning) return;
      detailedSimulationRunning = true;

      const output = document.getElementById("detailed-step-output");
      output.innerHTML = "";

      document.getElementById("detailed-progress-container").classList.remove("hidden");
      document.getElementById("detailed-reset-btn").classList.remove("hidden");

      const progressBar = document.getElementById("detailed-progress-bar");
      const progressText = document.getElementById("detailed-progress-text");

      const totalSteps = 7;
      let currentStep = 0;

      const updateProgress = () => {
        currentStep++;
        const percent = (currentStep / totalSteps) * 100;
        progressBar.style.width = percent + '%';
        progressText.textContent = `${currentStep}/${totalSteps} b∆∞·ªõc`;
      };

      // ===== STEP 1: LOAD IMAGE =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-blue-100 to-blue-50 border-2 border-blue-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-blue-700 mb-3">üì∏ STEP 1: LOAD IMAGE (T·∫£i ·∫¢nh)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-blue-300">
              <p class="text-sm font-semibold text-blue-700 mb-2">üé¨ Qu√° tr√¨nh t·∫£i ·∫£nh:</p>
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><span class="text-green-700">‚úì</span> ƒê·ªçc file: "cityscapes_foggy_001.jpg"</div>
                <div><span class="text-green-700">‚úì</span> Channels: 3 (Red, Green, Blue)</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-blue-700">üìê T√≠nh to√°n k√≠ch th∆∞·ªõc:</strong></div>
                <div class="bg-yellow-50 p-2 rounded mt-1">
                  <div>Total Pixels = Height √ó Width</div>
                  <div class="mt-1">= <span class="bg-yellow-200 px-1">800</span> √ó <span class="bg-yellow-200 px-1">1333</span></div>
                  <div class="text-blue-700 font-bold mt-1">= <span id="detailed-step1-pixels">ƒêang t√≠nh...</span> pixels</div>
                </div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-blue-700">üìä V√≠ d·ª• gi√° tr·ªã pixel:</strong></div>
                <div class="grid grid-cols-3 gap-2 mt-1">
                  <div class="bg-red-100 p-1 rounded text-center">R: <span id="detailed-step1-r">?</span></div>
                  <div class="bg-green-100 p-1 rounded text-center">G: <span id="detailed-step1-g">?</span></div>
                  <div class="bg-blue-100 p-1 rounded text-center">B: <span id="detailed-step1-b">?</span></div>
                </div>
              </div>
            </div>

            <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-500">
              <p class="text-sm"><strong>üì§ Output:</strong> Tensor shape = <span class="text-blue-600 font-mono">[1, 3, 800, 1333]</span></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("detailed-step1-pixels"), 0, 1066400, 800, '');
      await animateNumber(document.getElementById("detailed-step1-r"), 0, 125, 300, '');
      await animateNumber(document.getElementById("detailed-step1-g"), 0, 145, 300, '');
      await animateNumber(document.getElementById("detailed-step1-b"), 0, 160, 300, '');

      await sleep(600);

      // ===== STEP 2: NORMALIZE =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-orange-100 to-orange-50 border-2 border-orange-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-orange-700 mb-3">üîÑ STEP 2: NORMALIZE (Chu·∫©n H√≥a)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-orange-300">
              <p class="text-sm font-semibold text-orange-700 mb-2">‚öôÔ∏è C√¥ng th·ª©c chu·∫©n h√≥a:</p>
              <div class="text-center mb-3">
                \\( x_{norm} = \\frac{x - \\mu}{\\sigma} \\)
              </div>
              
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div><strong>ImageNet mean Œº:</strong> [0.485, 0.456, 0.406]</div>
                <div><strong>ImageNet std œÉ:</strong> [0.229, 0.224, 0.225]</div>
                
                <div class="mt-2 border-t border-gray-400 pt-2"><strong class="text-orange-700">üßÆ V√≠ d·ª• t√≠nh cho pixel (0,0):</strong></div>
                <div class="bg-yellow-50 p-2 rounded mt-1">
                  <div>R_norm = (125/255 - 0.485) / 0.229</div>
                  <div class="ml-4">= (<span class="bg-yellow-200 px-1">0.490</span> - <span class="bg-yellow-200 px-1">0.485</span>) / <span class="bg-yellow-200 px-1">0.229</span></div>
                  <div class="text-orange-700 font-bold ml-4">= <span id="detailed-step2-r">?</span></div>
                </div>
              </div>
            </div>

            <div class="bg-orange-50 p-3 rounded border-l-4 border-orange-500">
              <p class="text-sm"><strong>üì§ Output:</strong> Tensor normalized, values ‚àà [-2, 2]</p>
            </div>
          </div>
        `, 300);

      const rNorm = (125 / 255 - 0.485) / 0.229;
      await animateNumber(document.getElementById("detailed-step2-r"), 0, rNorm, 800, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(600);

      // ===== STEP 3: RESNET-50 BACKBONE =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-purple-100 to-purple-50 border-2 border-purple-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-purple-700 mb-3">üß† STEP 3: RESNET-50 BACKBONE</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-purple-300">
              <p class="text-sm font-semibold text-purple-700 mb-2">üîç Convolution Operations:</p>
              
              <div class="space-y-3 text-xs font-mono">
                <div class="bg-purple-50 p-2 rounded">
                  <div class="font-bold text-purple-700">Layer 1 (7√ó7 conv, stride 2):</div>
                  <div>Output = floor((800 + 2√ó3 - 7) / 2) + 1</div>
                  <div>= floor(<span class="bg-yellow-200 px-1">799</span> / 2) + 1 = <span id="detailed-step3-l1" class="bg-green-200 px-1">?</span></div>
                </div>
                
                <div class="bg-purple-50 p-2 rounded">
                  <div class="font-bold text-purple-700">Layer 2 (3√ó3 maxpool, stride 2):</div>
                  <div>Output = floor(400 / 2) = <span id="detailed-step3-l2" class="bg-green-200 px-1">?</span></div>
                </div>
                
                <div class="bg-purple-50 p-2 rounded">
                  <div class="font-bold text-purple-700">... qua nhi·ªÅu ResBlocks ...</div>
                </div>
                
                <div class="bg-purple-50 p-2 rounded">
                  <div class="font-bold text-purple-700">Final Output:</div>
                  <div>Shape = [1, <span id="detailed-step3-c">?</span>, <span id="detailed-step3-h">?</span>, <span id="detailed-step3-w">?</span>]</div>
                </div>
              </div>
            </div>

            <div class="bg-purple-50 p-3 rounded border-l-4 border-purple-500">
              <p class="text-sm"><strong>üì§ Output:</strong> Feature map <span class="text-purple-600 font-mono">[1, 2048, 25, 42]</span></p>
              <p class="text-xs text-gray-600 mt-1">T·ªïng: 25 √ó 42 √ó 2048 = <span id="detailed-step3-total" class="font-bold">?</span> feature values</p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("detailed-step3-l1"), 0, 400, 400, '');
      await animateNumber(document.getElementById("detailed-step3-l2"), 0, 200, 400, '');
      await animateNumber(document.getElementById("detailed-step3-c"), 0, 2048, 400, '');
      await animateNumber(document.getElementById("detailed-step3-h"), 0, 25, 300, '');
      await animateNumber(document.getElementById("detailed-step3-w"), 0, 42, 300, '');
      await animateNumber(document.getElementById("detailed-step3-total"), 0, 2150400, 800, '');

      await sleep(600);

      // ===== STEP 4: TRANSFORMER ENCODER =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-cyan-100 to-cyan-50 border-2 border-cyan-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-cyan-700 mb-3">üîÑ STEP 4: TRANSFORMER ENCODER</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-cyan-300">
              <p class="text-sm font-semibold text-cyan-700 mb-2">‚öôÔ∏è Self-Attention Calculation:</p>
              
              <div class="text-center mb-3">
                \\( \\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V \\)
              </div>
              
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div class="bg-cyan-50 p-2 rounded">
                  <div class="font-bold">Flatten: [1, 2048, 25, 42] ‚Üí [1050, 1, 256]</div>
                  <div>25 √ó 42 = <span id="detailed-step4-seq">?</span> positions</div>
                </div>
                
                <div class="bg-cyan-50 p-2 rounded mt-2">
                  <div class="font-bold">Attention weights (example):</div>
                  <div>Position 0 attends to:</div>
                  <div class="grid grid-cols-5 gap-1 mt-1">
                    <div class="bg-cyan-200 p-1 rounded text-center"><span id="detailed-step4-a0">?</span></div>
                    <div class="bg-cyan-300 p-1 rounded text-center"><span id="detailed-step4-a1">?</span></div>
                    <div class="bg-cyan-100 p-1 rounded text-center"><span id="detailed-step4-a2">?</span></div>
                    <div class="bg-cyan-200 p-1 rounded text-center"><span id="detailed-step4-a3">?</span></div>
                    <div class="bg-cyan-100 p-1 rounded text-center">...</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-cyan-50 p-3 rounded border-l-4 border-cyan-500">
              <p class="text-sm"><strong>üì§ Output:</strong> Memory <span class="text-cyan-600 font-mono">[1050, 1, 256]</span></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("detailed-step4-seq"), 0, 1050, 600, '');
      await animateNumber(document.getElementById("detailed-step4-a0"), 0, 0.15, 300, '');
      await animateNumber(document.getElementById("detailed-step4-a1"), 0, 0.32, 300, '');
      await animateNumber(document.getElementById("detailed-step4-a2"), 0, 0.08, 300, '');
      await animateNumber(document.getElementById("detailed-step4-a3"), 0, 0.12, 300, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(600);

      // ===== STEP 5: DECODER + OBJECT QUERIES =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-pink-100 to-pink-50 border-2 border-pink-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-pink-700 mb-3">üéØ STEP 5: DECODER + OBJECT QUERIES</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-pink-300">
              <p class="text-sm font-semibold text-pink-700 mb-2">‚öôÔ∏è Cross-Attention v·ªõi Memory:</p>
              
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div class="bg-pink-50 p-2 rounded">
                  <div class="font-bold">Object Queries: [300, 1, 256]</div>
                  <div>M·ªói query ƒë·∫°i di·ªán cho 1 v·∫≠t th·ªÉ ti·ªÅm nƒÉng</div>
                </div>
                
                <div class="bg-pink-50 p-2 rounded mt-2">
                  <div class="font-bold">Classification Head:</div>
                  <div>Linear(256, <span id="detailed-step5-nc">?</span>) ‚Üí class logits</div>
                </div>
                
                <div class="bg-pink-50 p-2 rounded mt-2">
                  <div class="font-bold">BBox Head (MLP):</div>
                  <div>MLP(256 ‚Üí 256 ‚Üí 256 ‚Üí 4) ‚Üí [cx, cy, w, h]</div>
                </div>
                
                <div class="bg-yellow-50 p-2 rounded mt-2">
                  <div class="font-bold text-pink-700">V√≠ d·ª• predictions:</div>
                  <div class="mt-1">Query #5: class=<span class="bg-green-200 px-1">car</span>, conf=<span id="detailed-step5-c5">?</span>%, box=[<span id="detailed-step5-box">loading...</span>]</div>
                </div>
              </div>
            </div>

            <div class="bg-pink-50 p-3 rounded border-l-4 border-pink-500">
              <p class="text-sm"><strong>üì§ Output:</strong> Classes <span class="text-pink-600 font-mono">[300, 9]</span>, Boxes <span class="text-pink-600 font-mono">[300, 4]</span></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("detailed-step5-nc"), 0, 9, 400, '');
      await animateNumber(document.getElementById("detailed-step5-c5"), 0, 95, 600, '');
      document.getElementById("detailed-step5-box").textContent = '0.35, 0.42, 0.15, 0.12';

      await sleep(600);

      // ===== STEP 6: CPA + DAS =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-green-100 to-green-50 border-2 border-green-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-green-700 mb-3">ü§ù STEP 6: CPA + DAS (Domain Alignment)</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-green-300">
              <p class="text-sm font-semibold text-green-700 mb-2">‚öôÔ∏è Prototype Extraction:</p>
              
              <div class="text-center mb-3">
                \\( P_c = \\frac{1}{N_c} \\sum_{i: class(q_i) = c} q_i \\)
              </div>
              
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div class="bg-green-50 p-2 rounded">
                  <div class="font-bold">Prototypes per class:</div>
                  <div class="grid grid-cols-3 gap-2 mt-1">
                    <div class="text-center">car: <span id="detailed-step6-car">?</span> queries</div>
                    <div class="text-center">person: <span id="detailed-step6-person">?</span> queries</div>
                    <div class="text-center">bike: <span id="detailed-step6-bike">?</span> queries</div>
                  </div>
                </div>
                
                <div class="bg-green-50 p-2 rounded mt-2">
                  <div class="font-bold">Contrastive Loss (InfoNCE):</div>
                  <div class="text-center mt-1">
                    \\( \\mathcal{L}_{con} = -\\log \\frac{\\exp(P_c \\cdot \\tilde{P}_c / \\tau)}{\\sum_{j=1}^{C} \\exp(P_c \\cdot \\tilde{P}_j / \\tau)} \\)
                  </div>
                  <div class="mt-2">
                    œÑ = <span class="bg-yellow-200 px-1">0.07</span>, C = <span class="bg-yellow-200 px-1">9</span> classes
                  </div>
                  <div class="text-green-700 font-bold">L_con = <span id="detailed-step6-lcon">?</span></div>
                </div>
              </div>
            </div>

            <div class="bg-green-50 p-3 rounded border-l-4 border-green-500">
              <p class="text-sm"><strong>üì§ Output:</strong> L_adv = <span id="detailed-step6-ladv" class="font-mono">?</span>, L_con = <span id="detailed-step6-lcon2" class="font-mono">?</span></p>
            </div>
          </div>
        `, 300);

      await animateNumber(document.getElementById("detailed-step6-car"), 0, 45, 400, '');
      await animateNumber(document.getElementById("detailed-step6-person"), 0, 38, 400, '');
      await animateNumber(document.getElementById("detailed-step6-bike"), 0, 22, 400, '');
      await animateNumber(document.getElementById("detailed-step6-lcon"), 0, 0.285, 600, '');
      await animateNumber(document.getElementById("detailed-step6-ladv"), 0, 0.452, 400, '');
      await animateNumber(document.getElementById("detailed-step6-lcon2"), 0, 0.285, 400, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      await sleep(600);

      // ===== STEP 7: FINAL RESULT =====
      updateProgress();
      await addStepWithAnimation(output, `
          <div class="bg-gradient-to-br from-yellow-100 to-yellow-50 border-2 border-yellow-500 rounded-lg p-5">
            <h3 class="text-lg font-bold text-yellow-700 mb-3">üèÅ STEP 7: FINAL RESULT</h3>
            
            <div class="bg-white p-4 rounded-lg mb-3 border border-yellow-300">
              <p class="text-sm font-semibold text-yellow-700 mb-2">üìä Total Loss Calculation:</p>
              
              <div class="text-center mb-3">
                \\( \\mathcal{L}_{total} = \\mathcal{L}_{det} + \\lambda_a \\mathcal{L}_{adv} + \\lambda_c \\mathcal{L}_{con} \\)
              </div>
              
              <div class="space-y-2 text-xs font-mono bg-stone-100 p-3 rounded">
                <div class="bg-yellow-50 p-2 rounded">
                  <div class="font-bold">Substituting values:</div>
                  <div class="mt-1">
                    L_total = <span class="bg-blue-200 px-1" id="detailed-step7-det">?</span> + 
                    <span class="bg-purple-200 px-1">0.1</span> √ó <span class="bg-purple-200 px-1" id="detailed-step7-adv">?</span> + 
                    <span class="bg-cyan-200 px-1">0.1</span> √ó <span class="bg-cyan-200 px-1" id="detailed-step7-con">?</span>
                  </div>
                  <div class="mt-2">
                    = <span id="detailed-step7-part1">?</span> + <span id="detailed-step7-part2">?</span> + <span id="detailed-step7-part3">?</span>
                  </div>
                  <div class="text-yellow-700 font-bold text-lg mt-2">= <span id="detailed-step7-total">?</span></div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
              <div class="bg-white p-3 rounded border-l-4 border-red-500 text-center">
                <p class="text-xs text-gray-600">Before DATR</p>
                <p class="text-3xl font-bold text-red-500"><span id="detailed-step7-before">0</span>%</p>
              </div>
              <div class="bg-white p-3 rounded border-l-4 border-green-500 text-center">
                <p class="text-xs text-gray-600">After DATR</p>
                <p class="text-3xl font-bold text-green-600"><span id="detailed-step7-after">0</span>%</p>
              </div>
            </div>

            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded border-2 border-green-500">
              <p class="text-sm font-bold text-green-700">‚úÖ Th√†nh C√¥ng!</p>
              <p class="text-xs text-green-700 mt-2">M√¥ h√¨nh ƒë√£ t·ª´ "nh√¨n th·∫•y pixel values" (Step 1) ‚Üí "hi·ªÉu ƒë∆∞·ª£c v·∫≠t th·ªÉ l√† g√¨" (Step 7)</p>
              <p class="text-xs text-green-700 mt-1">üìà Improvement: <strong>+17.2% mAP!</strong></p>
            </div>
          </div>
        `, 300);

      // Animate detailed calculation
      await animateNumber(document.getElementById("detailed-step7-det"), 0, 1.245, 500, '');
      await animateNumber(document.getElementById("detailed-step7-adv"), 0, 0.452, 500, '');
      await animateNumber(document.getElementById("detailed-step7-con"), 0, 0.285, 500, '');

      await sleep(500);

      await animateNumber(document.getElementById("detailed-step7-part1"), 0, 1.245, 400, '');
      await animateNumber(document.getElementById("detailed-step7-part2"), 0, 0.0452, 400, '');
      await animateNumber(document.getElementById("detailed-step7-part3"), 0, 0.0285, 400, '');

      const totalLoss = 1.245 + 0.0452 + 0.0285;
      await animateNumber(document.getElementById("detailed-step7-total"), 0, totalLoss, 800, '');

      await animateNumber(document.getElementById("detailed-step7-before"), 0, 35.6, 1200, '');
      await animateNumber(document.getElementById("detailed-step7-after"), 0, 52.8, 1200, '');

      if (window.MathJax) {
        MathJax.typesetPromise();
      }

      detailedSimulationRunning = false;
    }

    function resetDetailedSimulation() {
      detailedSimulationRunning = false;
      detailedCurrentStep = 0;
      document.getElementById("detailed-step-output").innerHTML = "";
      document.getElementById("detailed-progress-container").classList.add("hidden");
      document.getElementById("detailed-nav-container").classList.add("hidden");
      document.getElementById("detailed-start-btn").classList.remove("hidden");
      document.getElementById("detailed-progress-bar").style.width = "0%";
      document.getElementById("detailed-progress-text").textContent = "0/7 b∆∞·ªõc";
      // Reset next button state
      document.getElementById("detailed-next-btn").innerHTML = "B∆∞·ªõc ti·∫øp theo";
      document.getElementById("detailed-next-btn").disabled = false;
      document.getElementById("detailed-next-btn").classList.remove("bg-gray-400", "cursor-not-allowed");
      document.getElementById("detailed-next-btn").classList.add("bg-green-500", "hover:bg-green-600", "hover:scale-105");
    }

    function resetEasySimulation() {
      easySimulationRunning = false;
      easyCurrentStep = 0;
      document.getElementById("easy-simulation-output").innerHTML = "";
      document.getElementById("easy-progress-container").classList.add("hidden");
      document.getElementById("easy-nav-container").classList.add("hidden");
      document.getElementById("easy-start-btn").classList.remove("hidden");
      document.getElementById("easy-progress-bar").style.width = "0%";
      document.getElementById("easy-progress-text").textContent = "0/7 b∆∞·ªõc";
      // Reset next button state
      document.getElementById("easy-next-btn").innerHTML = "B∆∞·ªõc ti·∫øp theo";
      document.getElementById("easy-next-btn").disabled = false;
      document.getElementById("easy-next-btn").classList.remove("bg-gray-400", "cursor-not-allowed");
      document.getElementById("easy-next-btn").classList.add("bg-green-500", "hover:bg-green-600", "hover:scale-105");
    }

    // ========================================
    // CLICK-BY-CLICK STEP FUNCTIONS 
    // ========================================

    // Easy Simulation - Click by click
    let easyCurrentStep = 0;
    const easyTotalSteps = 7;

    function initEasySimulation() {
      easyCurrentStep = 0;
      document.getElementById("easy-simulation-output").innerHTML = "";
      document.getElementById("easy-progress-container").classList.remove("hidden");
      document.getElementById("easy-nav-container").classList.remove("hidden");
      document.getElementById("easy-start-btn").classList.add("hidden");
      document.getElementById("easy-progress-bar").style.width = "0%";
      document.getElementById("easy-progress-text").textContent = "0/7 b∆∞·ªõc";

      // Show first step immediately
      nextEasyStep();
    }

    async function nextEasyStep() {
      if (easyCurrentStep >= easyTotalSteps) {
        document.getElementById("easy-next-btn").innerHTML = "Ho√†n th√†nh!";
        document.getElementById("easy-next-btn").disabled = true;
        document.getElementById("easy-next-btn").classList.remove("bg-green-500", "hover:bg-green-600", "hover:scale-105");
        document.getElementById("easy-next-btn").classList.add("bg-gray-400", "cursor-not-allowed");
        return;
      }

      easyCurrentStep++;
      const percent = (easyCurrentStep / easyTotalSteps) * 100;
      document.getElementById("easy-progress-bar").style.width = percent + '%';
      document.getElementById("easy-progress-text").textContent = `${easyCurrentStep}/${easyTotalSteps} b∆∞·ªõc`;

      const output = document.getElementById("easy-simulation-output");

      switch (easyCurrentStep) {
        case 1:
          await addStepWithAnimation(output, getEasyStep1Html(), 100);
          if (window.MathJax) MathJax.typesetPromise();
          await sleep(300);
          document.getElementById("easy-step1-result").innerHTML = '= <span class="bg-green-200 px-2 py-1 rounded">6,399,200</span> pixel values';
          break;
        case 2:
          await addStepWithAnimation(output, getEasyStep2Html(), 100);
          if (window.MathJax) MathJax.typesetPromise();
          await sleep(300);
          await animateNumber(document.getElementById("easy-step2-h"), 0, 25, 500, '');
          await animateNumber(document.getElementById("easy-step2-w"), 0, 42, 500, '');
          document.getElementById("easy-step2-result").innerHTML = '[<span class="bg-green-200 px-1">2</span>, <span class="bg-green-200 px-1">2048</span>, <span class="bg-green-200 px-1">25</span>, <span class="bg-green-200 px-1">42</span>]';
          break;
        case 3:
          await addStepWithAnimation(output, getEasyStep3Html(), 100);
          await animateNumber(document.getElementById("easy-step3-conf1"), 0, 95, 800, '%');
          await animateNumber(document.getElementById("easy-step3-conf2"), 0, 87, 800, '%');
          break;
        case 4:
          await addStepWithAnimation(output, getEasyStep4Html(), 100);
          await animateNumber(document.getElementById("easy-step4-n1"), 0, 45, 600, '');
          await animateNumber(document.getElementById("easy-step4-n2"), 0, 38, 600, '');
          document.getElementById("easy-step4-v1").textContent = '0.42, 0.91, 0.28, ..., 0.68';
          document.getElementById("easy-step4-v2").textContent = '0.35, 0.82, 0.45, ..., 0.71';
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 5:
          await addStepWithAnimation(output, getEasyStep5Html(), 100);
          await animateNumber(document.getElementById("easy-step5-src"), 0, 0.92, 600, '');
          await animateNumber(document.getElementById("easy-step5-tgt"), 0, 0.78, 600, '');
          await animateNumber(document.getElementById("easy-step5-loss"), 0, 0.452, 800, '');
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 6:
          await addStepWithAnimation(output, getEasyStep6Html(), 100);
          const emaResult = 0.999 * 0.5234 + 0.001 * 0.5289;
          await animateNumber(document.getElementById("easy-step6-ema"), 0, emaResult, 800, '');
          await animateNumber(document.getElementById("easy-step6-sloss"), 0, 1.245, 600, '');
          document.getElementById("easy-step6-tweight").textContent = '‚úì Updated';
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 7:
          await addStepWithAnimation(output, getEasyStep7Html(), 100);
          await animateNumber(document.getElementById("easy-step7-det"), 0, 1.245, 500, '');
          await animateNumber(document.getElementById("easy-step7-adv"), 0, 0.452, 500, '');
          await animateNumber(document.getElementById("easy-step7-con"), 0, 0.285, 500, '');
          const totalLoss = 1.245 + 0.1 * 0.452 + 0.1 * 0.285;
          await animateNumber(document.getElementById("easy-step7-total"), 0, totalLoss, 800, '');
          await animateNumber(document.getElementById("easy-step7-baseline"), 0, 35.6, 1000, '');
          await animateNumber(document.getElementById("easy-step7-datr"), 0, 52.8, 1000, '');
          if (window.MathJax) MathJax.typesetPromise();
          document.getElementById("easy-next-btn").classList.add("hidden");
          break;
      }
    }

    // Step HTML generators for Easy Simulation
    function getEasyStep1Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-green-500 fade-in">
          <h4 class="font-semibold text-green-700 mb-3">B∆∞·ªõc 1: ƒê∆∞a ·∫¢nh V√†o (Input)</h4>
          <div class="space-y-2 text-sm">
            <p><strong>Ch√∫ng ta c√≥ 2 lo·∫°i ·∫£nh:</strong></p>
            <div class="flex flex-wrap gap-4 justify-center my-4">
              <div class="bg-primary-700 text-white p-4 rounded-lg text-center min-w-[180px]">
                <p class="font-medium">Source Domain</p>
                <p class="text-xs opacity-80">·∫¢nh ban ng√†y, r√µ r√†ng</p>
                <p class="text-xs bg-black/20 rounded px-2 py-1 mt-2 font-mono">[1, 3, 800, 1333]</p>
              </div>
              <div class="bg-rose-500 text-white p-4 rounded-lg text-center min-w-[180px]">
                <p class="font-medium">Target Domain</p>
                <p class="text-xs opacity-80">·∫¢nh s∆∞∆°ng m√π, m·ªù</p>
                <p class="text-xs bg-black/20 rounded px-2 py-1 mt-2 font-mono">[1, 3, 800, 1333]</p>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg border text-center">
              <strong>T√≠nh t·ªïng s·ªë pixels:</strong>
              <div class="mt-3">
                \\( \\text{Total} = B \\times C \\times H \\times W = 2 \\times 3 \\times 800 \\times 1333 \\)
              </div>
              <div class="text-green-700 font-bold mt-3 text-xl" id="easy-step1-result">= ƒêang t√≠nh...</div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Raw Images (RGB)</p>
                <p class="text-xs text-primary-500">Source + Target: 2 images</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">Tensor: [2, 3, 800, 1333]</p>
                <p class="text-xs text-primary-500">Normalized float32</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep2Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-blue-500 fade-in">
          <h4 class="font-semibold text-blue-700 mb-3">B∆∞·ªõc 2: Tr√≠ch Xu·∫•t ƒê·∫∑c Tr∆∞ng (ResNet-50)</h4>
          <div class="space-y-2 text-sm">
            <p><strong>D√πng m√¥ h√¨nh ResNet-50:</strong> Gi·∫£m k√≠ch th∆∞·ªõc nh∆∞ng gi·ªØ th√¥ng tin quan tr·ªçng.</p>
            <div class="flex flex-wrap items-center justify-center gap-3 my-4">
              <div class="bg-white border-2 border-primary-300 p-3 rounded-lg text-center">
                <strong>Input</strong>
                <p class="text-xs font-mono">[B, 3, 800, 1333]</p>
              </div>
              <span class="text-2xl text-primary-400">‚Üí</span>
              <div class="bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center">
                <strong>Conv Layers</strong>
              </div>
              <span class="text-2xl text-primary-400">‚Üí</span>
              <div class="bg-white border-2 border-primary-300 p-3 rounded-lg text-center">
                <strong>Features</strong>
                <p class="text-xs font-mono">[B, 2048, 25, 42]</p>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <strong>C√¥ng th·ª©c t√≠nh k√≠ch th∆∞·ªõc output:</strong>
              <div class="mt-3 space-y-3">
                <div class="text-center">
                  \\( H_{out} = \\frac{H_{in}}{\\text{stride}} = \\frac{800}{32} = \\) <span class="bg-green-200 px-2 py-1 rounded font-bold" id="easy-step2-h">?</span>
                </div>
                <div class="text-center">
                  \\( W_{out} = \\frac{W_{in}}{\\text{stride}} = \\frac{1333}{32} = \\) <span class="bg-green-200 px-2 py-1 rounded font-bold" id="easy-step2-w">?</span>
                </div>
                <div class="text-center mt-3">
                  <strong>Feature Map Shape:</strong> <span class="text-green-700 font-bold" id="easy-step2-result">[?, ?, ?, ?]</span>
                </div>
              </div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Image: [2, 3, 800, 1333]</p>
                <p class="text-xs text-primary-500">RGB normalized tensor</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">Features: [2, 2048, 25, 42]</p>
                <p class="text-xs text-primary-500">2,150,400 feature values</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep3Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-orange-500 fade-in">
          <h4 class="font-semibold text-orange-700 mb-3">B∆∞·ªõc 3: T√¨m V·∫≠t Th·ªÉ (Detection)</h4>
          <div class="space-y-2 text-sm">
            <p><strong>M√¥ h√¨nh d√πng 300 "Object Queries"</strong> qu√©t qua ·∫£nh t√¨m v·∫≠t th·ªÉ.</p>
            <div class="text-center my-4">
              <div class="inline-block p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <strong>Object Queries</strong>
                <div class="mt-2 flex flex-wrap gap-2 justify-center text-sm font-mono">
                  car | person | bike | bus | motorcycle | truck
                </div>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <strong>K·∫øt qu·∫£ Detection:</strong>
              <div class="mt-3 grid grid-cols-2 gap-3 font-mono text-xs">
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="text-orange-700 font-semibold">Query #5: Car</div>
                  <div class="mt-1">Confidence: <span id="easy-step3-conf1" class="font-bold text-green-600">0%</span></div>
                  <div>Box: [0.35, 0.42, 0.15, 0.12]</div>
                </div>
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="text-orange-700 font-semibold">Query #12: Person</div>
                  <div class="mt-1">Confidence: <span id="easy-step3-conf2" class="font-bold text-green-600">0%</span></div>
                  <div>Box: [0.60, 0.55, 0.08, 0.25]</div>
                </div>
              </div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Memory: [1050, 256]</p>
                <p class="text-sm font-mono">Queries: [300, 256]</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">Embeddings: [300, 256]</p>
                <p class="text-xs text-primary-500">Per-object features</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep4Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-purple-500 fade-in">
          <h4 class="font-semibold text-purple-700 mb-3">B∆∞·ªõc 4: T√≠nh Prototype (CPA Module)</h4>
          <div class="space-y-2 text-sm">
            <div class="bg-purple-50 border-l-4 border-purple-500 p-3 rounded-r text-sm mb-3">
              <strong>C√¥ng th·ª©c:</strong> \\( P_c = \\frac{1}{N_c} \\sum_{i: class(q_i) = c} q_i \\)
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="font-mono text-xs space-y-3">
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="font-semibold text-purple-700">Prototype_car:</div>
                  <div class="mt-1">= (Query_5 + Query_23 + ...) / <span id="easy-step4-n1" class="bg-yellow-200 px-2 py-1 rounded">?</span></div>
                  <div class="text-purple-600 mt-1">= Vector [<span id="easy-step4-v1">...</span>]</div>
                </div>
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="font-semibold text-purple-700">Prototype_person:</div>
                  <div class="mt-1">= (Query_12 + Query_45 + ...) / <span id="easy-step4-n2" class="bg-yellow-200 px-2 py-1 rounded">?</span></div>
                  <div class="text-purple-600 mt-1">= Vector [<span id="easy-step4-v2">...</span>]</div>
                </div>
              </div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Embeddings: [300, 256]</p>
                <p class="text-xs text-primary-500">Object query features</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">Prototypes: [C, 256]</p>
                <p class="text-xs text-primary-500">C = number of classes</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep5Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-cyan-500 fade-in">
          <h4 class="font-semibold text-cyan-700 mb-3">B∆∞·ªõc 5: CƒÉn Ch·ªânh Domain (Adversarial)</h4>
          <div class="space-y-2 text-sm">
            <div class="bg-cyan-50 border-l-4 border-cyan-500 p-3 rounded-r text-sm mb-3">
              <strong>Adversarial Loss:</strong> \\( \\mathcal{L}_{adv} = BCE(D(GRL(P)), y_{domain}) \\)
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="font-mono text-xs">
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="font-semibold text-cyan-700">Discriminator predictions:</div>
                  <div class="mt-2 space-y-1">
                    <div>- Source proto: D(P_src) = <span id="easy-step5-src" class="bg-green-200 px-2 py-1 rounded">?</span></div>
                    <div>- Target proto: D(P_tgt) = <span id="easy-step5-tgt" class="bg-green-200 px-2 py-1 rounded">?</span></div>
                  </div>
                  <div class="mt-3 pt-2 border-t">
                    <strong>L_adv = </strong>BCE(<span class="bg-yellow-200 px-1 rounded">0.92</span>, 1) + BCE(<span class="bg-yellow-200 px-1 rounded">0.78</span>, 0)
                  </div>
                  <div class="text-cyan-700 font-bold mt-2">= <span id="easy-step5-loss">?</span></div>
                </div>
              </div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Src_Proto: [C, 256]</p>
                <p class="text-sm font-mono">Tgt_Proto: [C, 256]</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">L_adv: scalar</p>
                <p class="text-xs text-primary-500">Adversarial loss value</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep6Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-amber-500 fade-in">
          <h4 class="font-semibold text-amber-700 mb-3">B∆∞·ªõc 6: Mean-Teacher Learning</h4>
          <div class="space-y-2 text-sm">
            <div class="bg-amber-50 border-l-4 border-amber-500 p-3 rounded-r text-sm mb-3">
              <strong>EMA Update:</strong> \\( \\theta_{teacher} \\leftarrow \\alpha \\cdot \\theta_{teacher} + (1-\\alpha) \\cdot \\theta_{student} \\)
            </div>
            <div class="bg-white p-4 rounded-lg border">
              <div class="font-mono text-xs">
                <div class="bg-stone-50 p-3 rounded-lg border">
                  <div class="font-semibold text-amber-700">V·ªõi Œ± = 0.999:</div>
                  <div class="mt-2">Œ∏_teacher = 0.999 √ó <span class="bg-blue-200 px-1 rounded">0.5234</span> + 0.001 √ó <span class="bg-purple-200 px-1 rounded">0.5289</span></div>
                  <div class="text-amber-700 font-bold mt-2">= <span id="easy-step6-ema">?</span></div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                <p class="font-semibold text-blue-600">Student</p>
                <p class="text-sm mt-2">Loss: <span id="easy-step6-sloss" class="font-mono font-bold">?</span></p>
              </div>
              <div class="bg-amber-50 p-4 rounded-lg border border-amber-200 text-center">
                <p class="font-semibold text-amber-600">Teacher</p>
                <p class="text-sm mt-2">Updated: <span id="easy-step6-tweight" class="font-mono font-bold">?</span></p>
              </div>
            </div>
            <!-- INPUT/OUTPUT Summary -->
            <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
              <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
                <p class="text-sm font-mono mt-1">Student Œ∏: [params]</p>
                <p class="text-sm font-mono">Teacher Œ∏: [params]</p>
              </div>
              <div class="bg-green-50 p-3 rounded border border-green-200">
                <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
                <p class="text-sm font-mono mt-1">Updated Teacher Œ∏</p>
                <p class="text-xs text-primary-500">EMA smoothed weights</p>
              </div>
            </div>
          </div>
        </div>`;
    }

    function getEasyStep7Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-accent-500 fade-in">
          <h4 class="font-semibold text-accent-700 mb-3">B∆∞·ªõc 7: K·∫øt Qu·∫£ Cu·ªëi C√πng</h4>
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="text-center mb-3">
              <strong class="text-primary-700">\\( \\mathcal{L}_{total} = \\mathcal{L}_{det} + \\lambda_a \\mathcal{L}_{adv} + \\lambda_c \\mathcal{L}_{con} \\)</strong>
            </div>
            <div class="font-mono text-sm bg-stone-50 p-3 rounded-lg border">
              <div>= <span class="bg-blue-200 px-2 py-1 rounded" id="easy-step7-det">?</span> + 0.1 √ó <span class="bg-purple-200 px-2 py-1 rounded" id="easy-step7-adv">?</span> + 0.1 √ó <span class="bg-cyan-200 px-2 py-1 rounded" id="easy-step7-con">?</span></div>
              <div class="text-accent-700 font-bold text-xl mt-3">= <span id="easy-step7-total">?</span></div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 text-center">
              <p class="text-sm text-primary-500">Baseline (Source only)</p>
              <p class="text-3xl font-bold text-red-500 my-2"><span id="easy-step7-baseline">0</span>%</p>
              <p class="text-xs text-primary-400">mAP</p>
            </div>
            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500 text-center">
              <p class="text-sm text-primary-500">DATR (Full)</p>
              <p class="text-3xl font-bold text-green-600 my-2"><span id="easy-step7-datr">0</span>%</p>
              <p class="text-xs text-primary-400">mAP</p>
            </div>
          </div>
          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r">
            <p class="font-semibold text-green-700">K·∫øt lu·∫≠n:</p>
            <p class="text-sm text-green-700 mt-1">DATR gi√∫p m√¥ h√¨nh c·∫£i thi·ªán t·ª´ <strong>35.6%</strong> ‚Üí <strong>52.8%</strong> (+17.2% mAP!)</p>
          </div>
          <!-- INPUT/OUTPUT Summary -->
          <div class="grid md:grid-cols-2 gap-3 mt-4 pt-4 border-t">
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
              <span class="text-xs font-semibold text-blue-600">üì• INPUT:</span>
              <p class="text-sm font-mono mt-1">L_det + L_adv + L_con</p>
              <p class="text-xs text-primary-500">Combined losses</p>
            </div>
            <div class="bg-green-50 p-3 rounded border border-green-200">
              <span class="text-xs font-semibold text-green-600">üì§ OUTPUT:</span>
              <p class="text-sm font-mono mt-1">mAP: 52.8%</p>
              <p class="text-xs text-primary-500">+17.2% improvement</p>
            </div>
          </div>
        </div>`;
    }

    // Detailed Simulation - Click by click
    let detailedCurrentStep = 0;
    const detailedTotalSteps = 7;

    function initDetailedSimulation() {
      detailedCurrentStep = 0;
      document.getElementById("detailed-step-output").innerHTML = "";
      document.getElementById("detailed-progress-container").classList.remove("hidden");
      document.getElementById("detailed-nav-container").classList.remove("hidden");
      document.getElementById("detailed-start-btn").classList.add("hidden");
      document.getElementById("detailed-progress-bar").style.width = "0%";
      document.getElementById("detailed-progress-text").textContent = "0/7 b∆∞·ªõc";

      // Show first step immediately
      nextDetailedStep();
    }

    async function nextDetailedStep() {
      if (detailedCurrentStep >= detailedTotalSteps) {
        document.getElementById("detailed-next-btn").innerHTML = "Ho√†n th√†nh!";
        document.getElementById("detailed-next-btn").disabled = true;
        document.getElementById("detailed-next-btn").classList.remove("bg-green-500", "hover:bg-green-600", "hover:scale-105");
        document.getElementById("detailed-next-btn").classList.add("bg-gray-400", "cursor-not-allowed");
        return;
      }

      detailedCurrentStep++;
      const percent = (detailedCurrentStep / detailedTotalSteps) * 100;
      document.getElementById("detailed-progress-bar").style.width = percent + '%';
      document.getElementById("detailed-progress-text").textContent = `${detailedCurrentStep}/${detailedTotalSteps} b∆∞·ªõc`;

      const output = document.getElementById("detailed-step-output");

      switch (detailedCurrentStep) {
        case 1:
          await addStepWithAnimation(output, getDetailedStep1Html(), 100);
          await animateNumber(document.getElementById("detailed-step1-pixels"), 0, 1066400, 800, '');
          await animateNumber(document.getElementById("detailed-step1-r"), 0, 125, 300, '');
          await animateNumber(document.getElementById("detailed-step1-g"), 0, 145, 300, '');
          await animateNumber(document.getElementById("detailed-step1-b"), 0, 160, 300, '');
          break;
        case 2:
          await addStepWithAnimation(output, getDetailedStep2Html(), 100);
          const rNorm = (125 / 255 - 0.485) / 0.229;
          await animateNumber(document.getElementById("detailed-step2-r"), 0, rNorm, 800, '');
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 3:
          await addStepWithAnimation(output, getDetailedStep3Html(), 100);
          if (window.MathJax) MathJax.typesetPromise();
          await animateNumber(document.getElementById("detailed-step3-l1"), 0, 400, 400, '');
          await animateNumber(document.getElementById("detailed-step3-l2"), 0, 200, 400, '');
          await animateNumber(document.getElementById("detailed-step3-c"), 0, 2048, 400, '');
          await animateNumber(document.getElementById("detailed-step3-h"), 0, 25, 300, '');
          await animateNumber(document.getElementById("detailed-step3-w"), 0, 42, 300, '');
          await animateNumber(document.getElementById("detailed-step3-total"), 0, 2150400, 800, '');
          break;
        case 4:
          await addStepWithAnimation(output, getDetailedStep4Html(), 100);
          await animateNumber(document.getElementById("detailed-step4-seq"), 0, 1050, 600, '');
          await animateNumber(document.getElementById("detailed-step4-a0"), 0, 0.15, 300, '');
          await animateNumber(document.getElementById("detailed-step4-a1"), 0, 0.32, 300, '');
          await animateNumber(document.getElementById("detailed-step4-a2"), 0, 0.08, 300, '');
          await animateNumber(document.getElementById("detailed-step4-a3"), 0, 0.12, 300, '');
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 5:
          await addStepWithAnimation(output, getDetailedStep5Html(), 100);
          await animateNumber(document.getElementById("detailed-step5-nc"), 0, 9, 400, '');
          await animateNumber(document.getElementById("detailed-step5-c5"), 0, 95, 600, '');
          document.getElementById("detailed-step5-box").textContent = '0.35, 0.42, 0.15, 0.12';
          break;
        case 6:
          await addStepWithAnimation(output, getDetailedStep6Html(), 100);
          await animateNumber(document.getElementById("detailed-step6-car"), 0, 45, 400, '');
          await animateNumber(document.getElementById("detailed-step6-person"), 0, 38, 400, '');
          await animateNumber(document.getElementById("detailed-step6-bike"), 0, 22, 400, '');
          await animateNumber(document.getElementById("detailed-step6-lcon"), 0, 0.285, 600, '');
          await animateNumber(document.getElementById("detailed-step6-ladv"), 0, 0.452, 400, '');
          await animateNumber(document.getElementById("detailed-step6-lcon2"), 0, 0.285, 400, '');
          if (window.MathJax) MathJax.typesetPromise();
          break;
        case 7:
          await addStepWithAnimation(output, getDetailedStep7Html(), 100);
          await animateNumber(document.getElementById("detailed-step7-det"), 0, 1.245, 500, '');
          await animateNumber(document.getElementById("detailed-step7-adv"), 0, 0.452, 500, '');
          await animateNumber(document.getElementById("detailed-step7-con"), 0, 0.285, 500, '');
          await sleep(300);
          await animateNumber(document.getElementById("detailed-step7-part1"), 0, 1.245, 400, '');
          await animateNumber(document.getElementById("detailed-step7-part2"), 0, 0.0452, 400, '');
          await animateNumber(document.getElementById("detailed-step7-part3"), 0, 0.0285, 400, '');
          const totalLoss = 1.245 + 0.0452 + 0.0285;
          await animateNumber(document.getElementById("detailed-step7-total"), 0, totalLoss, 800, '');
          await animateNumber(document.getElementById("detailed-step7-before"), 0, 35.6, 1000, '');
          await animateNumber(document.getElementById("detailed-step7-after"), 0, 52.8, 1000, '');
          if (window.MathJax) MathJax.typesetPromise();
          document.getElementById("detailed-next-btn").classList.add("hidden");
          break;
      }
    }

    // Detailed Step HTML generators
    function getDetailedStep1Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-green-500 fade-in">
          <h4 class="font-semibold text-green-700 mb-3">STEP 1: LOAD IMAGE (T·∫£i ·∫¢nh)</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <p class="text-sm font-semibold text-green-700 mb-2">Qu√° tr√¨nh t·∫£i ·∫£nh:</p>
            <div class="code-block p-3 rounded text-xs">
              <div><span class="text-green-400">‚úì</span> ƒê·ªçc file: "cityscapes_foggy_001.jpg"</div>
              <div><span class="text-green-400">‚úì</span> Channels: 3 (Red, Green, Blue)</div>
            </div>
            <div class="bg-stone-50 p-3 rounded-lg border mt-3">
              <strong class="text-green-700">T√≠nh to√°n k√≠ch th∆∞·ªõc:</strong>
              <div class="font-mono text-sm mt-2">
                <div class="text-primary-500">Total Pixels = Height √ó Width</div>
                <div class="text-primary-700 mt-1">= <span class="bg-yellow-200 px-1 rounded">800</span> √ó <span class="bg-yellow-200 px-1 rounded">1333</span></div>
                <div class="text-green-700 font-bold mt-2">= <span id="detailed-step1-pixels">ƒêang t√≠nh...</span> pixels</div>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2 mt-3">
              <div class="bg-red-50 p-2 rounded-lg border border-red-200 text-center">R: <span id="detailed-step1-r" class="font-bold">?</span></div>
              <div class="bg-green-50 p-2 rounded-lg border border-green-200 text-center">G: <span id="detailed-step1-g" class="font-bold">?</span></div>
              <div class="bg-blue-50 p-2 rounded-lg border border-blue-200 text-center">B: <span id="detailed-step1-b" class="font-bold">?</span></div>
            </div>
          </div>
          <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> Tensor shape = <span class="text-green-600 font-mono">[1, 3, 800, 1333]</span></p>
          </div>
        </div>`;
    }

    function getDetailedStep2Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-blue-500 fade-in">
          <h4 class="font-semibold text-blue-700 mb-3">STEP 2: NORMALIZE (Chu·∫©n H√≥a)</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r mb-3">
              <strong>C√¥ng th·ª©c chu·∫©n h√≥a:</strong> \\( x_{norm} = \\frac{x - \\mu}{\\sigma} \\)
            </div>
            <div class="code-block p-3 rounded text-xs">
              <div><strong>ImageNet mean Œº:</strong> [0.485, 0.456, 0.406]</div>
              <div><strong>ImageNet std œÉ:</strong> [0.229, 0.224, 0.225]</div>
            </div>
            <div class="bg-stone-50 p-3 rounded-lg border mt-3">
              <strong class="text-blue-700">V√≠ d·ª• t√≠nh cho pixel (0,0):</strong>
              <div class="mt-3 text-center">
                \\( R_{norm} = \\frac{125/255 - 0.485}{0.229} = \\frac{0.490 - 0.485}{0.229} = \\) <span id="detailed-step2-r" class="bg-green-200 px-2 py-1 rounded font-bold">?</span>
              </div>
            </div>
          </div>
          <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> Tensor normalized, values ‚àà [-2, 2]</p>
          </div>
        </div>`;
    }

    function getDetailedStep3Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-orange-500 fade-in">
          <h4 class="font-semibold text-orange-700 mb-3">STEP 3: RESNET-50 BACKBONE</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <p class="text-sm font-semibold text-orange-700 mb-3">Convolution Operations:</p>
            <div class="space-y-3">
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-orange-700">Layer 1 (7√ó7 conv, stride 2):</div>
                <div class="mt-2 text-center">
                  \\( \\text{Output} = \\lfloor \\frac{800 + 2 \\times 3 - 7}{2} \\rfloor + 1 = \\) <span id="detailed-step3-l1" class="bg-green-200 px-2 py-1 rounded font-bold">?</span>
                </div>
              </div>
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-orange-700">Layer 2 (3√ó3 maxpool, stride 2):</div>
                <div class="mt-2 text-center">
                  \\( \\text{Output} = \\lfloor \\frac{400}{2} \\rfloor = \\) <span id="detailed-step3-l2" class="bg-green-200 px-2 py-1 rounded font-bold">?</span>
                </div>
              </div>
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-orange-700">Final Output Shape:</div>
                <div class="font-mono text-sm mt-2 text-center">[1, <span id="detailed-step3-c" class="font-bold">?</span>, <span id="detailed-step3-h" class="font-bold">?</span>, <span id="detailed-step3-w" class="font-bold">?</span>]</div>
              </div>
            </div>
          </div>
          <div class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> Feature map <span class="text-orange-600 font-mono">[1, 2048, 25, 42]</span></p>
            <p class="text-xs text-primary-500 mt-1">T·ªïng: \\( 25 \\times 42 \\times 2048 = \\) <span id="detailed-step3-total" class="font-bold">?</span> feature values</p>
          </div>
        </div>`;
    }

    function getDetailedStep4Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-cyan-500 fade-in">
          <h4 class="font-semibold text-cyan-700 mb-3">STEP 4: TRANSFORMER ENCODER</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <div class="bg-cyan-50 border-l-4 border-cyan-500 p-3 rounded-r mb-3">
              <strong>Self-Attention:</strong> \\( \\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V \\)
            </div>
            <div class="space-y-3">
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-cyan-700">Flatten spatial dimensions:</div>
                <div class="font-mono text-sm mt-1">[1, 2048, 25, 42] ‚Üí [1050, 1, 256]</div>
                <div class="text-sm mt-1">25 √ó 42 = <span id="detailed-step4-seq" class="bg-green-200 px-2 py-1 rounded font-bold">?</span> positions</div>
              </div>
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-cyan-700">Attention weights (example):</div>
                <div class="grid grid-cols-5 gap-2 mt-2">
                  <div class="bg-cyan-100 p-2 rounded-lg text-center font-mono text-sm"><span id="detailed-step4-a0">?</span></div>
                  <div class="bg-cyan-200 p-2 rounded-lg text-center font-mono text-sm"><span id="detailed-step4-a1">?</span></div>
                  <div class="bg-cyan-100 p-2 rounded-lg text-center font-mono text-sm"><span id="detailed-step4-a2">?</span></div>
                  <div class="bg-cyan-100 p-2 rounded-lg text-center font-mono text-sm"><span id="detailed-step4-a3">?</span></div>
                  <div class="bg-cyan-50 p-2 rounded-lg text-center">...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-cyan-50 border-l-4 border-cyan-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> Memory <span class="text-cyan-600 font-mono">[1050, 1, 256]</span></p>
          </div>
        </div>`;
    }

    function getDetailedStep5Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-pink-500 fade-in">
          <h4 class="font-semibold text-pink-700 mb-3">STEP 5: DECODER + OBJECT QUERIES</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <p class="text-sm font-semibold text-pink-700 mb-3">Cross-Attention v·ªõi Memory:</p>
            <div class="text-center my-4">
              <div class="inline-block p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <strong>Object Queries</strong>
                <div class="mt-2 flex flex-wrap gap-1 justify-center text-sm font-mono">
                </div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-pink-700">Classification Head:</div>
                <div class="font-mono text-sm mt-1">Linear(256, <span id="detailed-step5-nc" class="bg-green-200 px-2 py-1 rounded font-bold">?</span>) ‚Üí class logits</div>
              </div>
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-pink-700">V√≠ d·ª• predictions:</div>
                <div class="font-mono text-sm mt-1">Query #5: class=<span class="bg-green-200 px-1 rounded">car</span>, conf=<span id="detailed-step5-c5" class="font-bold">?</span>%, box=[<span id="detailed-step5-box">loading...</span>]</div>
              </div>
            </div>
          </div>
          <div class="bg-pink-50 border-l-4 border-pink-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> Classes <span class="text-pink-600 font-mono">[300, 9]</span>, Boxes <span class="text-pink-600 font-mono">[300, 4]</span></p>
          </div>
        </div>`;
    }

    function getDetailedStep6Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-purple-500 fade-in">
          <h4 class="font-semibold text-purple-700 mb-3">STEP 6: CPA + DAS (Domain Alignment)</h4>
          <div class="bg-white p-4 rounded-lg mb-3 border">
            <div class="bg-purple-50 border-l-4 border-purple-500 p-3 rounded-r mb-3">
              <strong>Prototype Extraction:</strong> \\( P_c = \\frac{1}{N_c} \\sum_{i: class(q_i) = c} q_i \\)
            </div>
            <div class="space-y-3">
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-purple-700">Prototypes per class:</div>
                <div class="grid grid-cols-3 gap-3 mt-2 font-mono text-sm">
                  <div class="bg-white p-2 rounded-lg border text-center">car: <span id="detailed-step6-car" class="font-bold">?</span></div>
                  <div class="bg-white p-2 rounded-lg border text-center">person: <span id="detailed-step6-person" class="font-bold">?</span></div>
                  <div class="bg-white p-2 rounded-lg border text-center">bike: <span id="detailed-step6-bike" class="font-bold">?</span></div>
                </div>
              </div>
              <div class="bg-stone-50 p-3 rounded-lg border">
                <div class="font-semibold text-purple-700">Contrastive Loss:</div>
                <div class="text-purple-700 font-bold mt-1">L_con = <span id="detailed-step6-lcon">?</span></div>
              </div>
            </div>
          </div>
          <div class="bg-purple-50 border-l-4 border-purple-500 p-3 rounded-r">
            <p class="text-sm"><strong>Output:</strong> L_adv = <span id="detailed-step6-ladv" class="font-mono font-bold">?</span>, L_con = <span id="detailed-step6-lcon2" class="font-mono font-bold">?</span></p>
          </div>
        </div>`;
    }

    function getDetailedStep7Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-accent-500 fade-in">
          <h4 class="font-semibold text-accent-700 mb-3">STEP 7: FINAL RESULT</h4>
          <div class="bg-white p-4 rounded-lg mb-4 border">
            <div class="text-center mb-3">
              <strong class="text-primary-700">\\( \\mathcal{L}_{total} = \\mathcal{L}_{det} + \\lambda_a \\mathcal{L}_{adv} + \\lambda_c \\mathcal{L}_{con} \\)</strong>
            </div>
            <div class="bg-stone-50 p-3 rounded-lg border font-mono text-sm">
              <div class="font-semibold text-primary-700">Substituting values:</div>
              <div class="mt-2">
                L_total = <span class="bg-blue-200 px-2 py-1 rounded" id="detailed-step7-det">?</span> + 
                <span class="bg-purple-200 px-1 rounded">0.1</span> √ó <span class="bg-purple-200 px-2 py-1 rounded" id="detailed-step7-adv">?</span> + 
                <span class="bg-cyan-200 px-1 rounded">0.1</span> √ó <span class="bg-cyan-200 px-2 py-1 rounded" id="detailed-step7-con">?</span>
              </div>
              <div class="mt-2">= <span id="detailed-step7-part1">?</span> + <span id="detailed-step7-part2">?</span> + <span id="detailed-step7-part3">?</span></div>
              <div class="text-accent-700 font-bold text-xl mt-3">= <span id="detailed-step7-total">?</span></div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 text-center">
              <p class="text-sm text-primary-500">Before DATR</p>
              <p class="text-3xl font-bold text-red-500 my-2"><span id="detailed-step7-before">0</span>%</p>
              <p class="text-xs text-primary-400">mAP</p>
            </div>
            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500 text-center">
              <p class="text-sm text-primary-500">After DATR</p>
              <p class="text-3xl font-bold text-green-600 my-2"><span id="detailed-step7-after">0</span>%</p>
              <p class="text-xs text-primary-400">mAP</p>
            </div>
          </div>
          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r">
            <p class="font-semibold text-green-700">Th√†nh c√¥ng!</p>
            <p class="text-sm text-green-700 mt-1">Improvement: <strong>+17.2% mAP!</strong></p>
          </div>
        </div>`;
    }

    // ========== VISUAL STEP-BY-STEP SIMULATION ==========
    let visualCurrentStep = 0;
    const visualTotalSteps = 7;

    function resetVisualSimulation() {
      visualCurrentStep = 0;
      document.getElementById("visual-step-output").innerHTML = '';
      document.getElementById("visual-progress-container").classList.add("hidden");
      document.getElementById("visual-nav-container").classList.add("hidden");
      document.getElementById("visual-start-container").classList.remove("hidden");
      document.getElementById("visual-next-btn").innerHTML = "B∆∞·ªõc ti·∫øp theo";
      document.getElementById("visual-next-btn").disabled = false;
      document.getElementById("visual-next-btn").classList.remove("bg-gray-400", "cursor-not-allowed");
      document.getElementById("visual-next-btn").classList.add("bg-purple-600", "hover:bg-purple-700", "hover:scale-105");
    }

    function initVisualSimulation() {
      resetVisualSimulation();
      document.getElementById("visual-start-container").classList.add("hidden");
      document.getElementById("visual-progress-container").classList.remove("hidden");
      document.getElementById("visual-nav-container").classList.remove("hidden");
      nextVisualStep();
    }

    async function nextVisualStep() {
      if (visualCurrentStep >= visualTotalSteps) {
        document.getElementById("visual-next-btn").innerHTML = "Ho√†n th√†nh!";
        document.getElementById("visual-next-btn").disabled = true;
        document.getElementById("visual-next-btn").classList.remove("bg-purple-600", "hover:bg-purple-700", "hover:scale-105");
        document.getElementById("visual-next-btn").classList.add("bg-gray-400", "cursor-not-allowed");
        return;
      }

      visualCurrentStep++;
      const percent = (visualCurrentStep / visualTotalSteps) * 100;
      document.getElementById("visual-progress-bar").style.width = percent + '%';
      document.getElementById("visual-progress-text").textContent = `${visualCurrentStep}/${visualTotalSteps} b∆∞·ªõc`;

      const output = document.getElementById("visual-step-output");

      switch (visualCurrentStep) {
        case 1:
          await addStepWithAnimation(output, getVisualStep1Html(), 100);
          break;
        case 2:
          await addStepWithAnimation(output, getVisualStep2Html(), 100);
          break;
        case 3:
          await addStepWithAnimation(output, getVisualStep3Html(), 100);
          break;
        case 4:
          await addStepWithAnimation(output, getVisualStep4Html(), 100);
          break;
        case 5:
          await addStepWithAnimation(output, getVisualStep5Html(), 100);
          break;
        case 6:
          await addStepWithAnimation(output, getVisualStep6Html(), 100);
          break;
        case 7:
          await addStepWithAnimation(output, getVisualStep7Html(), 100);
          document.getElementById("visual-next-btn").classList.add("hidden");
          break;
      }
    }

    function getVisualStep1Html() {
      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-green-500 fade-in">
          <h4 class="font-semibold text-green-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
            Input: Source vs Target Domain
          </h4>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="relative">
              <div class="absolute -top-3 left-4 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold z-10">SOURCE DOMAIN</div>
              <img src="images/source_clear.png" alt="Clear cityscape" class="w-full rounded-lg shadow-lg border-4 border-blue-500">
              <p class="text-center mt-2 text-sm text-primary-600">·∫¢nh r√µ r√†ng - C√≥ labels</p>
            </div>
            <div class="relative">
              <div class="absolute -top-3 left-4 bg-rose-600 text-white px-3 py-1 rounded-full text-xs font-bold z-10">TARGET DOMAIN</div>
              <img src="images/target_foggy.png" alt="Foggy cityscape" class="w-full rounded-lg shadow-lg border-4 border-rose-500">
              <p class="text-center mt-2 text-sm text-primary-600">·∫¢nh s∆∞∆°ng m√π - Kh√¥ng c√≥ labels</p>
            </div>
          </div>
          <div class="text-center mt-4">
            <span class="inline-block bg-amber-100 text-amber-700 px-4 py-2 rounded-lg text-sm">
              Th√°ch th·ª©c: L√†m sao ƒë·ªÉ ph√°t hi·ªán v·∫≠t th·ªÉ trong s∆∞∆°ng m√π khi ch·ªâ ƒë∆∞·ª£c hu·∫•n luy·ªán tr√™n ·∫£nh r√µ?
            </span>
          </div>
        </div>`;
    }

    function getVisualStep2Html() {
      // Start processing animation after render
      setTimeout(() => {
        const progressBar = document.getElementById('step2-progress');
        const statusText = document.getElementById('step2-status');
        const layerText = document.getElementById('step2-layer');
        const featuresText = document.getElementById('step2-features');

        if (!progressBar) return;

        let progress = 0;
        const layers = ['conv1', 'layer1', 'layer2', 'layer3', 'layer4'];
        let layerIndex = 0;

        const interval = setInterval(() => {
          progress += 2;
          progressBar.style.width = progress + '%';

          if (progress % 20 === 0 && layerIndex < layers.length) {
            layerText.textContent = 'Processing: ' + layers[layerIndex];
            layerIndex++;
          }

          if (progress >= 100) {
            clearInterval(interval);
            statusText.textContent = 'Ho√†n th√†nh!';
            statusText.classList.remove('text-blue-600');
            statusText.classList.add('text-green-600');
            featuresText.classList.remove('opacity-50');
            featuresText.classList.add('animate-pulse', 'ring-2', 'ring-green-500');
          }
        }, 30);
      }, 100);

      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-blue-500 fade-in">
          <h4 class="font-semibold text-blue-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
            Feature Extraction (ResNet-50)
          </h4>
          
          <!-- Processing Animation -->
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="step2-layer" class="text-sm font-mono text-blue-600">Initializing...</span>
              <span id="step2-status" class="text-sm font-medium text-blue-600">Processing...</span>
            </div>
            <div class="w-full bg-stone-200 rounded-full h-3">
              <div id="step2-progress" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="flex items-center justify-center gap-4 mb-4">
            <div class="text-center">
              <div class="w-32 h-24 bg-gradient-to-br from-blue-200 to-blue-400 rounded-lg flex items-center justify-center text-xs font-mono">Input Image<br>[3, 800, 1333]</div>
            </div>
            <div class="text-4xl text-blue-500 animate-pulse">‚Üí</div>
            <div class="text-center p-4 bg-blue-100 rounded-lg border-2 border-blue-300 animate-pulse">
              <div class="text-3xl mb-2 animate-spin-slow">‚öôÔ∏è</div>
              <strong class="text-blue-700">ResNet-50</strong>
            </div>
            <div class="text-4xl text-blue-500 animate-pulse">‚Üí</div>
            <div id="step2-features" class="text-center opacity-50 transition-all duration-500">
              <div class="w-32 h-24 bg-gradient-to-br from-purple-200 to-purple-400 rounded-lg flex items-center justify-center text-xs font-mono">Features<br>[2048, 25, 42]</div>
            </div>
          </div>
          <img src="images/step2_features.png" alt="Feature Extraction" class="w-full max-w-md mx-auto rounded-lg shadow-md border">
          <p class="text-center text-sm text-primary-600 mt-3">·∫¢nh ƒë∆∞·ª£c chuy·ªÉn th√†nh Feature Map - gi·∫£m k√≠ch th∆∞·ªõc nh∆∞ng gi·ªØ th√¥ng tin quan tr·ªçng</p>
        </div>`;
    }

    function getVisualStep3Html() {
      // Start transformer processing animation
      setTimeout(() => {
        const progressBar = document.getElementById('step3-progress');
        const statusText = document.getElementById('step3-status');
        const attentionText = document.getElementById('step3-attention');
        const memoryOutput = document.getElementById('step3-memory');

        if (!progressBar) return;

        let progress = 0;
        const encoderLayers = ['Encoder Layer 1/6', 'Encoder Layer 2/6', 'Encoder Layer 3/6', 'Encoder Layer 4/6', 'Encoder Layer 5/6', 'Encoder Layer 6/6'];
        let layerIndex = 0;

        const interval = setInterval(() => {
          progress += 1.5;
          progressBar.style.width = Math.min(progress, 100) + '%';

          // Update attention scores display
          const score1 = (Math.random() * 0.3 + 0.7).toFixed(2);
          const score2 = (Math.random() * 0.2 + 0.1).toFixed(2);
          attentionText.textContent = `Attention: [${score1}, ${score2}, ...]`;

          if (progress % 16 === 0 && layerIndex < encoderLayers.length) {
            statusText.textContent = encoderLayers[layerIndex];
            layerIndex++;
          }

          if (progress >= 100) {
            clearInterval(interval);
            statusText.textContent = 'Ho√†n th√†nh!';
            statusText.classList.remove('text-orange-600');
            statusText.classList.add('text-green-600');
            attentionText.textContent = 'Memory encoded: 1050 tokens';
            memoryOutput.classList.remove('opacity-50');
            memoryOutput.classList.add('animate-pulse', 'ring-2', 'ring-green-500');
          }
        }, 40);
      }, 100);

      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-orange-500 fade-in">
          <h4 class="font-semibold text-orange-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
            Transformer Encoder (Self-Attention)
          </h4>
          
          <!-- Processing Animation -->
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="step3-attention" class="text-sm font-mono text-orange-600">Computing attention...</span>
              <span id="step3-status" class="text-sm font-medium text-orange-600">Initializing...</span>
            </div>
            <div class="w-full bg-stone-200 rounded-full h-3">
              <div id="step3-progress" class="bg-gradient-to-r from-orange-500 to-yellow-500 h-3 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="flex items-center justify-center gap-4 mb-4">
            <div class="text-center p-4 bg-purple-100 rounded-lg">
              <div class="text-2xl mb-1">Features</div>
              <div class="text-xs font-mono">[2048, 25, 42]</div>
            </div>
            <div class="text-4xl text-orange-500 animate-pulse">‚Üí</div>
            <div class="text-center p-4 bg-orange-100 rounded-lg border-2 border-orange-300 animate-pulse">
              <div class="text-3xl mb-2">‚ö°</div>
              <strong class="text-orange-700">Self-Attention</strong>
              <p class="text-xs">6 Encoder Layers</p>
            </div>
            <div class="text-4xl text-orange-500 animate-pulse">‚Üí</div>
            <div id="step3-memory" class="text-center p-4 bg-cyan-100 rounded-lg opacity-50 transition-all duration-500">
              <div class="text-2xl mb-1">Memory</div>
              <div class="text-xs font-mono">[1050, 256]</div>
            </div>
          </div>
          <img src="images/step3_transformer.png" alt="Self-Attention" class="w-full max-w-md mx-auto rounded-lg shadow-md border">
          <p class="text-center text-sm text-primary-600 mt-3">Attention cho ph√©p m·ªói v·ªã tr√≠ feature "nh√¨n th·∫•y" context to√†n ·∫£nh</p>
        </div>`;
    }

    function getVisualStep4Html() {
      // Start object queries animation
      setTimeout(() => {
        const progressBar = document.getElementById('step4-progress');
        const statusText = document.getElementById('step4-status');
        const queryCount = document.getElementById('step4-queries');
        const detections = document.getElementById('step4-detections');

        if (!progressBar) return;

        let progress = 0;
        let queriesProcessed = 0;
        let detectCount = 0;

        const interval = setInterval(() => {
          progress += 2;
          queriesProcessed = Math.min(Math.floor(progress * 3), 300);
          progressBar.style.width = Math.min(progress, 100) + '%';
          queryCount.textContent = `${queriesProcessed}/300 queries`;

          // Randomly add detections
          if (progress % 15 === 0 && detectCount < 6) {
            detectCount++;
            statusText.textContent = `Found ${detectCount} objects...`;
          }

          if (progress >= 100) {
            clearInterval(interval);
            statusText.textContent = 'Ho√†n th√†nh!';
            statusText.classList.remove('text-pink-600');
            statusText.classList.add('text-green-600');
            queryCount.textContent = '6 objects detected';
            detections.classList.remove('opacity-50');
            detections.classList.add('animate-pulse');
          }
        }, 25);
      }, 100);

      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-pink-500 fade-in">
          <h4 class="font-semibold text-pink-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</span>
            Decoder + Object Queries
          </h4>
          
          <!-- Processing Animation -->
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="step4-queries" class="text-sm font-mono text-pink-600">0/300 queries</span>
              <span id="step4-status" class="text-sm font-medium text-pink-600">Scanning image...</span>
            </div>
            <div class="w-full bg-stone-200 rounded-full h-3">
              <div id="step4-progress" class="bg-gradient-to-r from-pink-500 to-rose-500 h-3 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="text-center mb-4">
            <div class="inline-block p-4 bg-amber-50 border border-amber-200 rounded-lg animate-pulse">
              <strong>300 Object Queries</strong> - ƒêang qu√©t ·∫£nh t√¨m v·∫≠t th·ªÉ...
            </div>
          </div>
          <img src="images/step4_queries.png" alt="Object Queries" class="w-full max-w-lg mx-auto rounded-lg shadow-md border mb-4">
          <div id="step4-detections" class="grid md:grid-cols-3 gap-4 text-center opacity-50 transition-all duration-500">
            <div class="bg-green-100 p-3 rounded-lg border border-green-300">
              <div class="text-2xl">üöó</div>
              <strong class="text-green-700">car</strong>
              <p class="text-xs">Query #5, #23, #87</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg border border-blue-300">
              <div class="text-2xl">üö∂</div>
              <strong class="text-blue-700">person</strong>
              <p class="text-xs">Query #12, #45</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-lg border border-yellow-300">
              <div class="text-2xl">üö≤</div>
              <strong class="text-yellow-700">bike</strong>
              <p class="text-xs">Query #67</p>
            </div>
          </div>
        </div>`;
    }

    function getVisualStep5Html() {
      // Start CPA alignment animation
      setTimeout(() => {
        const progressBar = document.getElementById('step5-progress');
        const statusText = document.getElementById('step5-status');
        const distanceText = document.getElementById('step5-distance');
        const sourceCircle = document.getElementById('step5-source');
        const targetCircle = document.getElementById('step5-target');

        if (!progressBar) return;

        let progress = 0;
        let distance = 2.5;

        const interval = setInterval(() => {
          progress += 1.5;
          distance = Math.max(2.5 - (progress * 0.025), 0.1);
          progressBar.style.width = Math.min(progress, 100) + '%';
          distanceText.textContent = `Distance: ${distance.toFixed(2)}`;

          // Move circles closer
          const offset = 50 - (progress * 0.3);
          if (sourceCircle) sourceCircle.style.transform = `translateX(${offset}px)`;
          if (targetCircle) targetCircle.style.transform = `translateX(-${offset}px)`;

          if (progress >= 100) {
            clearInterval(interval);
            statusText.textContent = 'Aligned!';
            statusText.classList.remove('text-purple-600');
            statusText.classList.add('text-green-600');
            distanceText.textContent = 'Distance: 0.10 ‚úì';
            distanceText.classList.add('text-green-600');
          }
        }, 35);
      }, 100);

      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-purple-500 fade-in">
          <h4 class="font-semibold text-purple-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold">5</span>
            CPA: Class-wise Prototype Alignment
          </h4>
          
          <!-- Processing Animation -->
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="step5-distance" class="text-sm font-mono text-purple-600">Distance: 2.50</span>
              <span id="step5-status" class="text-sm font-medium text-purple-600">Aligning domains...</span>
            </div>
            <div class="w-full bg-stone-200 rounded-full h-3">
              <div id="step5-progress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
          </div>
          
          <img src="images/step5_alignment.png" alt="Prototype Alignment" class="w-full max-w-xs mx-auto rounded-lg shadow-md border mb-4">
          <div class="flex items-center justify-center gap-6 overflow-hidden">
            <div class="text-center transition-transform duration-300" id="step5-source" style="transform: translateX(50px)">
              <div class="w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">S</div>
              <p class="mt-2 font-medium">Source</p>
            </div>
            <div class="flex-1 max-w-32">
              <div class="h-3 bg-gradient-to-r from-blue-500 via-purple-500 to-rose-500 rounded-full"></div>
              <p class="text-center text-sm mt-2 font-medium text-purple-600">‚Üê Converging ‚Üí</p>
            </div>
            <div class="text-center transition-transform duration-300" id="step5-target" style="transform: translateX(-50px)">
              <div class="w-20 h-20 bg-rose-500 rounded-full flex items-center justify-center text-white font-bold text-xl">T</div>
              <p class="mt-2 font-medium">Target</p>
            </div>
          </div>
          <p class="text-center text-sm text-primary-600 mt-4">Adversarial learning cƒÉn ch·ªânh prototypes ƒë·ªÉ Discriminator kh√¥ng th·ªÉ ph√¢n bi·ªát Source/Target</p>
        </div>`;
    }

    function getVisualStep6Html() {
      // Start DAS memory bank animation
      setTimeout(() => {
        const progressBar = document.getElementById('step6-progress');
        const statusText = document.getElementById('step6-status');
        const memoryCount = document.getElementById('step6-memory');
        const memoryItems = document.querySelectorAll('.memory-item');
        const contrastiveResult = document.getElementById('step6-contrastive');

        if (!progressBar) return;

        let progress = 0;
        let itemIndex = 0;

        const interval = setInterval(() => {
          progress += 2;
          progressBar.style.width = Math.min(progress, 100) + '%';
          memoryCount.textContent = `${Math.min(Math.floor(progress * 1.5), 150)} prototypes`;

          // Show memory items one by one
          if (itemIndex < memoryItems.length && progress % 12 === 0) {
            memoryItems[itemIndex].classList.remove('opacity-0', 'scale-0');
            memoryItems[itemIndex].classList.add('opacity-100', 'scale-100');
            itemIndex++;
          }

          if (progress >= 100) {
            clearInterval(interval);
            statusText.textContent = 'Aligned!';
            statusText.classList.remove('text-cyan-600');
            statusText.classList.add('text-green-600');
            memoryCount.textContent = '150 prototypes stored';
            contrastiveResult.classList.remove('opacity-50');
            contrastiveResult.classList.add('animate-pulse');
          }
        }, 30);
      }, 100);

      return `
        <div class="bg-stone-50 p-5 rounded-lg border-l-4 border-cyan-500 fade-in">
          <h4 class="font-semibold text-cyan-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center text-sm font-bold">6</span>
            DAS: Dataset-level Alignment Strategy
          </h4>
          
          <!-- Processing Animation -->
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="flex items-center justify-between mb-2">
              <span id="step6-memory" class="text-sm font-mono text-cyan-600">0 prototypes</span>
              <span id="step6-status" class="text-sm font-medium text-cyan-600">Building memory bank...</span>
            </div>
            <div class="w-full bg-stone-200 rounded-full h-3">
              <div id="step6-progress" class="bg-gradient-to-r from-cyan-500 to-teal-500 h-3 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="bg-white p-4 rounded-lg border mb-4">
            <div class="text-center mb-3">
              <strong>Memory Bank - T√≠ch l≈©y prototypes t·ª´ to√†n dataset</strong>
            </div>
            <div class="flex flex-wrap justify-center gap-2">
              <span class="memory-item px-3 py-1 bg-green-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">car_1</span>
              <span class="memory-item px-3 py-1 bg-green-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">car_2</span>
              <span class="memory-item px-3 py-1 bg-blue-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">person_1</span>
              <span class="memory-item px-3 py-1 bg-blue-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">person_2</span>
              <span class="memory-item px-3 py-1 bg-yellow-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">bike_1</span>
              <span class="memory-item px-3 py-1 bg-purple-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">bus_1</span>
              <span class="memory-item px-3 py-1 bg-orange-200 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">truck_1</span>
              <span class="memory-item px-3 py-1 bg-stone-300 rounded-full text-sm opacity-0 scale-0 transition-all duration-300">+143 more</span>
            </div>
          </div>
          <div id="step6-contrastive" class="bg-cyan-50 p-4 rounded-lg border border-cyan-200 opacity-50 transition-all duration-500">
            <strong class="text-cyan-700">Contrastive Learning:</strong>
            <ul class="text-sm mt-2 space-y-1">
              <li class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Positive: car ‚Üî car (g·∫ßn nhau)</li>
              <li class="flex items-center gap-2"><span class="text-red-500">‚úó</span> Negative: car ‚Üî person (xa nhau)</li>
            </ul>
          </div>
        </div>`;
    }

    function getVisualStep7Html() {
      return `
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border-2 border-green-500 fade-in">
          <h4 class="font-semibold text-green-700 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">7</span>
            K·∫øt qu·∫£: Detection tr√™n ·∫£nh s∆∞∆°ng m√π
          </h4>
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="relative">
              <div class="absolute -top-3 left-4 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold z-10">TRAIN: CLEAR</div>
              <img src="images/detect_clear.png" alt="Detection on clear" class="w-full rounded-lg shadow-lg border-4 border-green-500">
              <p class="text-center mt-2 text-sm text-green-600 font-semibold">mAP: 95.2%</p>
            </div>
            <div class="relative">
              <div class="absolute -top-3 left-4 bg-emerald-600 text-white px-3 py-1 rounded-full text-xs font-bold z-10">TEST: FOGGY (DATR)</div>
              <img src="images/detect_foggy.png" alt="Detection on foggy with DATR" class="w-full rounded-lg shadow-lg border-4 border-emerald-500">
              <p class="text-center mt-2 text-sm text-emerald-600 font-semibold">mAP: 52.8%</p>
            </div>
          </div>
          <div class="text-center">
            
            <h3 class="text-2xl font-bold text-green-700 mb-2">DATR Th√†nh C√¥ng!</h3>
            <div class="flex justify-center gap-8 mt-4">
              <div class="text-center bg-red-100 px-6 py-3 rounded-lg">
                <div class="text-3xl font-bold text-red-500">35.6%</div>
                <div class="text-sm text-red-600">Baseline</div>
              </div>
              <div class="text-4xl text-primary-400 flex items-center">‚Üí</div>
              <div class="text-center bg-green-100 px-6 py-3 rounded-lg">
                <div class="text-3xl font-bold text-green-600">52.8%</div>
                <div class="text-sm text-green-700">DATR (+17.2%)</div>
              </div>
            </div>
          </div>
        </div>`;
    }
  </script>
</body>

</html>